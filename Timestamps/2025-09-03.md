
#### Work
---
- [x] ë¬¸ì œí•´ê²°í•„ìš”: ë² ì´ì§ 6ê°œì›” -> í”„ë¦¬ë¯¸ì—„ 6ê°œì›” ì‹œ ì •ê¸°ê²°ì œê°€ 2ê°œê°€ ë˜ëŠ” ë¬¸ì œ
	- changeTypeì´ ì—…ê·¸ë ˆì´ë“œì¼ ë•Œ subscriptionUpgradeì— ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ì•¼ í•¨
- [ ] ë¬¸ì œí•´ê²°í•„ìš”: ë² ì´ì§ 1ê°œì›” -> ë² ì´ì§ 6ê°œì›” | í”„ë¦¬ë¯¸ì—„ 1ê°œì›” -> í”„ë¦¬ë¯¸ì—„ 6ê°œì›” ì ìš© ì‹œ ìœ ì €ì •ë³´ ì¡°íšŒìš© me APIê°€ FREE | FREE_PLANìœ¼ë¡œ ë‚ ì•„ì˜¤ëŠ” ì´ìœ 
- [ ] shadcn-ui Dialog open ìƒíƒœì—ì„œ toast ë°œìƒ ì‹œ toast ì°½ì„ ì¡°ì‘ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½ (pointer-event)
- [ ] API ì¤‘ë³µí˜¸ì¶œ ì˜ì‹¬ë˜ëŠ” ë¡œì§ ë³´ì™„ 
- [ ] ê²°ì œê´€ë ¨ì½”ë“œ ê°€ë…ì„± ì™„í™”
- [ ] ê²°ì œ ì´ 3ë‹¨ê³„ì— ëŒ€í•œ ë¡œë”© ì»´í¬ë„ŒíŠ¸ ë°˜ì˜
- [ ] ë””ë²„ê¹… ì½”ë“œ ì œê±°


> ë‹¤ì‹œ ë¡¤ë°±í•  ì½”ë“œ
```tsx
import { useCallback, useEffect, useState } from 'react'  
import { toast } from 'sonner'  
import { useOpenMembershipDialog } from '@/pages/my-page/hooks/modal/use-open-membership-dialog.ts'  
import { useAuthStore } from '@/store/use-auth-store.ts'  
import type { DeviceType } from '@/pages/auth/types'  
import { useQueryClient } from '@tanstack/react-query'  
import { useGetUserInfo } from '@/hooks/use-get-user-info-query.ts'  
import { usePaymentInitiate } from '@/pages/my-page/hooks/action/use-payment-initiate-action.ts'  
import { useVerifyGoogleAction } from '@/pages/my-page/hooks/action/use-verify-google-action.ts'  
import type {  
  BasePlanTypeEnum,  
  InnerPaymentPlanId,  
  PaymentInitiationRequest,  
  PaymentInitiationResponse,  
  PaymentPlatformEnum,  
  PaymentVerificationCommonRequest,  
  ProductTypeEnum,  
} from '@/pages/my-page/types'  
import { getCurrentMembershipPlan } from '@/pages/my-page/utils.ts'  
import { useGooglePayment } from '@/pages/my-page/hooks/payment/use-google-payment.ts'  
import { useAppStorePayment } from './use-app-store-payment'  
  
// Google Payment Hookì˜ íƒ€ì…ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€  
interface PaymentOption {  
  id: InnerPaymentPlanId  
  membershipType: 'PREMIUM' | 'BASIC'  
  plan: 'monthly' | 'sixMonthly'  
}  
  
interface PurchaseResult {  
  success: boolean  
  status?: 'success' | 'pending' | 'failed' | 'cancelled' | 'restored'  
  message?: string  
  error?: string  
  errorMessage?: string  
  errorCode?: string  
  debug?: any  
  availableProducts?: string[]  
  availableBasePlans?: string[]  
  platform?: string  
  receiptData?: string  
  productId?: string  
  transactionId?: string  
  secretKey?: string  
  fcmToken?: string  
  basePlanId?: string  
}  
  
export function useMembershipPayment() {  
  const queryClient = useQueryClient()  
  const { open, onClose: originalOnClose } = useOpenMembershipDialog()  
  const [deviceType, setDeviceType] = useState<DeviceType>('WEB')  
  const [selectedPaymentOption, setSelectedPaymentOption] = useState<InnerPaymentPlanId | null>(null)  
  const [secretKey, setSecretKey] = useState<string | null>(null)  
  const [resSecretKey, setResSecretKey] = useState<string | null>(null)  
  const [isAuthReady, setIsAuthReady] = useState(false)  
  const [isPaymentProcessing, setIsPaymentProcessing] = useState(false)  
  const [authInitialized, setAuthInitialized] = useState(false)  
  const [paymentInitiationResponse, setPaymentInitiationResponse] = useState<PaymentInitiationResponse | null>(null)  
  
  // 2ë‹¨ê³„ ê²°ì œ ëŒ€ê¸° ìƒíƒœ ì¶”ê°€  
  const [pendingSecondStep, setPendingSecondStep] = useState<{  
    paymentInitiationResponse: PaymentInitiationResponse  
    paymentOption: PaymentOption  
  } | null>(null)  
  
  // ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°  
  const { data: user } = useGetUserInfo(open)  
  
  // Payment hooks  
  const paymentInitiateMutation = usePaymentInitiate()  
  const verifyGoogleMutation = useVerifyGoogleAction()  
  
  // Auth ì´ˆê¸°í™” í•¨ìˆ˜ë¥¼ ë¶„ë¦¬  
  const initializeAuth = useCallback(async () => {  
    try {  
      setIsAuthReady(false)  
      setAuthInitialized(false)  
  
      // ë””ë°”ì´ìŠ¤ íƒ€ì…ê³¼ í† í°ì„ ë™ì‹œì— ê°€ì ¸ì˜¤ê¸°  
      const [type, token] = await Promise.all([useAuthStore.getDeviceType(), useAuthStore.getToken()])  
  
      setDeviceType(type as DeviceType)  
      setSecretKey(token)  
      setIsAuthReady(true)  
      setAuthInitialized(true)  
    } catch (error) {  
      setDeviceType('WEB')  
      setSecretKey(null)  
      setIsAuthReady(true)  
      setAuthInitialized(true)  
    }  
  }, [])  
  
  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ì´ˆê¸°í™”  
  useEffect(() => {  
    initializeAuth()  
  }, [open, initializeAuth])  
  
  // ë””ë°”ì´ìŠ¤ë³„ ê²°ì œ í›… í™œì„±í™” ì¡°ê±´  
  const isGooglePaymentEnabled = deviceType === 'ANDROID' && !!resSecretKey  
  const isAppStorePaymentEnabled = deviceType === 'IOS' && !!resSecretKey  
  
  // êµ¬ë… ë³€ê²½ íƒ€ì… íŒë³„ - ìˆ˜ì •ëœ ë²„ì „  
  const getSubscriptionChangeType = (targetOptionId: InnerPaymentPlanId) => {  
    if (!user?.membershipType || !user?.subscriptionPlan) {  
      return 'new'  
    }  
  
    // í˜„ì¬ êµ¬ë… ì¤‘ì¸ í”Œëœ í™•ì¸  
    const currentPlan = getCurrentMembershipPlan(user.membershipType, user.subscriptionPlan)  
  
    // í˜„ì¬ ë¬´ë£Œ ì‚¬ìš©ìì¸ ê²½ìš° ì‹ ê·œ ê²°ì œ  
    if (!currentPlan) {  
      return 'new'  
    }  
  
    const targetPlan = targetOptionId  
  
    // ì—…ê·¸ë ˆì´ë“œ (Basic â†’ Premium, ê°™ì€ ê¸°ê°„ ë˜ëŠ” ë‹¤ë¥¸ ê¸°ê°„)  
    if (currentPlan === 'basic-monthly' && targetPlan === 'premium-monthly') {  
      return 'upgrade'  
    }  
    // ğŸ†• ë² ì´ì§ 6ê°œì›” â†’ í”„ë¦¬ë¯¸ì—„ 6ê°œì›” ì—…ê·¸ë ˆì´ë“œ  
    if (currentPlan === 'basic-sixmonthly' && targetPlan === 'premium-sixmonthly') {  
      return 'upgrade'  
    }  
  
    // ë‹¤ìš´ê·¸ë ˆì´ë“œ (Premium â†’ Basic, ê°™ì€ ê¸°ê°„)  
    if (currentPlan === 'premium-monthly' && targetPlan === 'basic-monthly') {  
      return 'downgrade'  
    }  
  
    // ê¸°ê°„ ë³€ê²½ - ê°™ì€ í”Œëœì—ì„œ ê¸°ê°„ë§Œ ë³€ê²½  
    if (  
      (currentPlan === 'basic-monthly' && targetPlan === 'basic-sixmonthly') ||  
      (currentPlan === 'premium-monthly' && targetPlan === 'premium-sixmonthly')  
    ) {  
      return 'periodChange'  
    }  
  
    // í”Œëœê³¼ ê¸°ê°„ ëª¨ë‘ ë³€ê²½ (ë² ì´ì§ ì›”ê°„ â†’ í”„ë¦¬ë¯¸ì—„ 6ê°œì›” ë“±) - periodChangeë¡œ ì²˜ë¦¬  
    if (  
      (currentPlan === 'basic-monthly' && targetPlan === 'premium-sixmonthly') ||  
      (currentPlan === 'premium-monthly' && targetPlan === 'basic-sixmonthly') ||  
      (currentPlan === 'basic-sixmonthly' && targetPlan === 'premium-monthly') ||  
      (currentPlan === 'premium-sixmonthly' && targetPlan === 'basic-monthly')  
    ) {  
      return 'periodChange'  
    }  
  
    return 'change'  
  }  
  
  // PaymentPlanIdë¥¼ PaymentInitiationRequestë¡œ ë³€í™˜  
  const convertToPaymentInitiationRequest = (optionId: InnerPaymentPlanId): PaymentInitiationRequest => {  
    const platformMap: Record<DeviceType, PaymentPlatformEnum> = {  
      ANDROID: 'GOOGLE',  
      IOS: 'APPLE',  
      WEB: 'GOOGLE', // ì›¹ì€ ê¸°ë³¸ì ìœ¼ë¡œ êµ¬ê¸€ë¡œ ì²˜ë¦¬  
    }  
  
    const productTypeMap: Record<InnerPaymentPlanId, ProductTypeEnum> = {  
      'premium-monthly': 'PREMIUM',  
      'premium-sixmonthly': 'PREMIUM',  
      'basic-monthly': 'BASIC',  
      'basic-sixmonthly': 'BASIC',  
    }  
  
    const basePlanTypeMap: Record<InnerPaymentPlanId, BasePlanTypeEnum> = {  
      'premium-monthly': 'PREMIUM_MONTHLY',  
      'premium-sixmonthly': 'PREMIUM_SIX_MONTHS',  
      'basic-monthly': 'PREMIUM_MONTHLY', // ê¸°ë³¸ì€ monthlyë¡œ ë§¤í•‘  
      'basic-sixmonthly': 'PREMIUM_SIX_MONTHS',  
    }  
  
    return {  
      platform: platformMap[deviceType],  
      productType: productTypeMap[optionId],  
      basePlanType: basePlanTypeMap[optionId],  
    }  
  }  
  
  // Google Payment Hook - ì•ˆë“œë¡œì´ë“œì¼ ë•Œë§Œ í™œì„±í™”  
  const {  
    isProcessing: isGoogleProcessing,  
    processingOptionId: googleProcessingOptionId,  
    purchaseProduct: purchaseGoogleProduct,  
    subscriptionUpgrade,  
    subscriptionDowngrade,  
    subscriptionPeriodChange,  
    resetPaymentState: resetGooglePaymentState,  
  } = useGooglePayment({  
    secretKey: resSecretKey || undefined,  
    enabled: isGooglePaymentEnabled,  
    onPurchaseSuccess: async (result: PurchaseResult) => {  
      await handleSecondStepSuccess(result)  
    },  
    onPurchaseError: (error: string) => {  
      handlePaymentFailure(`Google Play ê²°ì œ ì‹¤íŒ¨: ${error}`)  
    },  
    onReceiptVerification: async (result: PurchaseResult) => {  
      await handleReceiptVerification(result)  
    },  
  })  
  
  // App Store Payment Hook - iOSì¼ ë•Œë§Œ í™œì„±í™”  
  const {  
    isProcessing: isAppStoreProcessing,  
    processingOptionId: appStoreProcessingOptionId,  
    purchaseProduct: purchaseAppStoreProduct,  
    resetPaymentState: resetAppStorePaymentState,  
  } = useAppStorePayment({  
    secretKey: resSecretKey || undefined,  
    enabled: isAppStorePaymentEnabled,  
    onPurchaseSuccess: async (result: PurchaseResult) => {  
      await handleSecondStepSuccess(result)  
    },  
    onPurchaseError: (error: string) => {  
      handlePaymentFailure(`App Store ê²°ì œ ì‹¤íŒ¨: ${error}`)  
    },  
    onReceiptVerification: async (result: PurchaseResult) => {},  
  })  
  
  // âœ… ì™„ì „í•œ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ - ëª¨ë“  ìƒíƒœë¥¼ ì²˜ìŒ ë Œë”ë§ë  ë•Œì™€ ë™ì¼í•˜ê²Œ ì´ˆê¸°í™”  
  const resetAllStates = useCallback(() => {  
    console.log('ğŸ”„ ëª¨ë“  ê²°ì œ ê´€ë ¨ ìƒíƒœë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•©ë‹ˆë‹¤...')  
  
    // 1. ê¸°ë³¸ ìƒíƒœë“¤ ì´ˆê¸°í™”  
    setSelectedPaymentOption(null)  
    setResSecretKey(null)  
    setIsPaymentProcessing(false)  
    setPaymentInitiationResponse(null)  
    setPendingSecondStep(null)  
  
    // 2. ê° ê²°ì œ í›…ì˜ ë‚´ë¶€ ìƒíƒœ ì´ˆê¸°í™”  
    resetGooglePaymentState?.()  
    resetAppStorePaymentState?.()  
  
    // 3. Mutation ìƒíƒœë“¤ ì´ˆê¸°í™”  
    paymentInitiateMutation.reset?.()  
    verifyGoogleMutation.reset?.()  
  
    console.log('âœ… ëª¨ë“  ê²°ì œ ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ')  
  }, [resetGooglePaymentState, resetAppStorePaymentState, paymentInitiateMutation, verifyGoogleMutation])  
  
  const onClose = () => {  
    originalOnClose(() => {  
      // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ì„ ë•Œë„ ì™„ì „ ì´ˆê¸°í™”  
      resetAllStates()  
    })  
  }  
  
  // ê¸°ì¡´ resetPaymentState í•¨ìˆ˜ë„ resetAllStatesë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •  
  const resetPaymentState = useCallback(() => {  
    resetAllStates()  
  }, [resetAllStates])  
  
  // âœ… ê²°ì œ ì‹¤íŒ¨ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ - ì™„ì „í•œ ìƒíƒœ ì´ˆê¸°í™” ì ìš©  
  const handlePaymentFailure = useCallback(  
    (errorMessage: string) => {  
      console.error('âŒ Payment failed:', errorMessage)  
      toast.error(errorMessage)  
  
      // ëª¨ë“  ìƒíƒœë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”  
      resetAllStates()  
    },  
    [resetAllStates],  
  )  
  
  const convertToPaymentOption = (optionId: InnerPaymentPlanId): PaymentOption | null => {  
    const optionMap: Record<InnerPaymentPlanId, PaymentOption> = {  
      'premium-monthly': { id: 'premium-monthly', membershipType: 'PREMIUM', plan: 'monthly' },  
      'premium-sixmonthly': { id: 'premium-sixmonthly', membershipType: 'PREMIUM', plan: 'sixMonthly' },  
      'basic-monthly': { id: 'basic-monthly', membershipType: 'BASIC', plan: 'monthly' },  
      'basic-sixmonthly': { id: 'basic-sixmonthly', membershipType: 'BASIC', plan: 'sixMonthly' },  
    }  
    return optionMap[optionId] || null  
  }  
  
  // resSecretKeyê°€ ì„¤ì •ë˜ë©´ ëŒ€ê¸° ì¤‘ì¸ 2ë‹¨ê³„ ê²°ì œë¥¼ ì‹¤í–‰í•˜ëŠ” effect ì¶”ê°€  
  useEffect(() => {  
    if (resSecretKey && pendingSecondStep) {  
      console.log('resSecretKeyê°€ ì„¤ì •ë˜ì–´ 2ë‹¨ê³„ ê²°ì œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤:', resSecretKey.substring(0, 10) + '...')  
      executeSecondStep(pendingSecondStep.paymentInitiationResponse, pendingSecondStep.paymentOption)  
      setPendingSecondStep(null) // ì‹¤í–‰ í›„ ëŒ€ê¸° ìƒíƒœ í•´ì œ  
    }  
  }, [resSecretKey, pendingSecondStep])  
  
  // ğŸ†• í˜„ì¬ êµ¬ë… ê¸°ê°„ í™•ì¸ í—¬í¼ í•¨ìˆ˜  
  const getCurrentSubscriptionPeriod = (): 'monthly' | 'sixmonthly' | null => {  
    if (!user?.membershipType || !user?.subscriptionPlan) {  
      return null  
    }  
  
    const currentPlan = getCurrentMembershipPlan(user.membershipType, user.subscriptionPlan)  
  
    if (currentPlan === 'basic-monthly' || currentPlan === 'premium-monthly') {  
      return 'monthly'  
    } else if (currentPlan === 'basic-sixmonthly' || currentPlan === 'premium-sixmonthly') {  
      return 'sixmonthly'  
    }  
  
    return null  
  }  
  
  // 2ë‹¨ê³„ ì‹¤í–‰ í•¨ìˆ˜ ë¶„ë¦¬  
  const executeSecondStep = async (  
    paymentInitiationResponse: PaymentInitiationResponse,  
    paymentOption: PaymentOption,  
  ) => {  
    try {  
      const changeType = getSubscriptionChangeType(paymentOption.id)  
  
      // paymentInitiationResponseì˜ receiptDataë¥¼ purchaseTokenìœ¼ë¡œ ì‚¬ìš©  
      const purchaseToken = paymentInitiationResponse.receiptData  
  
      switch (deviceType) {  
        case 'ANDROID':  
          // êµ¬ë… ë³€ê²½ì¸ì§€ ì‹ ê·œ êµ¬ë§¤ì¸ì§€ íŒë³„í•˜ì—¬ ì ì ˆí•œ í•¨ìˆ˜ í˜¸ì¶œ  
          if (changeType === 'new' || !purchaseToken) {  
            await purchaseGoogleProduct(paymentOption)  
          } else {  
            // êµ¬ë… ë³€ê²½ ì²˜ë¦¬  
            switch (changeType) {  
              case 'upgrade': {  
                const currentPeriod = getCurrentSubscriptionPeriod()  
                await subscriptionUpgrade(purchaseToken, currentPeriod || 'monthly')  
                break  
              }  
              case 'downgrade':  
                await subscriptionDowngrade(purchaseToken)  
                break  
              case 'periodChange': {  
                // í˜„ì¬ í”Œëœê³¼ ëª©í‘œ í”Œëœ ì •ë³´ ì¶”ì¶œ - ìˆ˜ì •ëœ ë¡œì§  
                let currentPlan: 'basic' | 'premium'  
                let toPlan: 'basic' | 'premium'  
  
                // í˜„ì¬ í”Œëœ ì •ë³´ë¥¼ user ê°ì²´ì—ì„œ ê°€ì ¸ì˜¤ê¸°  
                if (user?.membershipType === 'BASIC') {  
                  currentPlan = 'basic'  
                } else if (user?.membershipType === 'PREMIUM') {  
                  currentPlan = 'premium'  
                } else {  
                  throw new Error('í˜„ì¬ êµ¬ë… ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')  
                }  
  
                // ëª©í‘œ í”Œëœ ì •ë³´ë¥¼ paymentOptionì—ì„œ ê°€ì ¸ì˜¤ê¸°  
                if (paymentOption.membershipType === 'BASIC') {  
                  toPlan = 'basic'  
                } else {  
                  toPlan = 'premium'  
                }  
  
                console.log(`êµ¬ë… ê¸°ê°„ ë³€ê²½: ${currentPlan} â†’ ${toPlan}`)  
                await subscriptionPeriodChange(purchaseToken, currentPlan, toPlan)  
                break  
              }  
              default:  
                // ì¼ë°˜ êµ¬ë… ë³€ê²½ì€ purchaseProduct ì‚¬ìš©  
                await purchaseGoogleProduct(paymentOption)  
                break  
            }  
          }  
          break  
  
        case 'IOS':  
          // iOSëŠ” ì•„ì§ êµ¬ë… ë³€ê²½ ê¸°ëŠ¥ ë¯¸ì§€ì› (ê¸°ë³¸ purchaseProductë§Œ ì‚¬ìš©)  
          throw new Error('ì•„ì§ iOS ë””ë°”ì´ìŠ¤ì—ì„œ App Store ê²°ì œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')  
          // await purchaseAppStoreProduct(paymentOption)  
          break  
  
        case 'WEB':  
          throw new Error('ì›¹ì—ì„œëŠ” ë‹¤ë¥¸ ê²°ì œ ë°©ì‹ì„ ì´ìš©í•´ì£¼ì„¸ìš”.')  
  
        default:  
          throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë””ë°”ì´ìŠ¤ íƒ€ì…ì…ë‹ˆë‹¤.')  
      }  
    } catch (error) {  
      const errorMessage = error instanceof Error ? error.message : '2ë‹¨ê³„ ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'  
      handlePaymentFailure(errorMessage)  
    }  
  }  
  
  // 1ë‹¨ê³„ ì„±ê³µ í›„ 2ë‹¨ê³„ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì • (ìˆ˜ì •ë¨)  
  const handleFirstStepSuccess = async (  
    paymentInitiationResponse: PaymentInitiationResponse,  
    paymentOption: PaymentOption,  
  ) => {  
    try {  
      setPaymentInitiationResponse(paymentInitiationResponse)  
  
      if (paymentInitiationResponse.secretKey) {  
        setResSecretKey(paymentInitiationResponse.secretKey)  
        // resSecretKeyê°€ ì„¤ì •ë˜ë©´ useEffectì—ì„œ 2ë‹¨ê³„ê°€ ìë™ ì‹¤í–‰ë¨  
        setPendingSecondStep({ paymentInitiationResponse, paymentOption })  
      } else {  
        throw new Error('1ë‹¨ê³„ ê²°ì œì—ì„œ secretKeyë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.')  
      }  
    } catch (error) {  
      const errorMessage = error instanceof Error ? error.message : '1ë‹¨ê³„ ê²°ì œ ì™„ë£Œ í›„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'  
      handlePaymentFailure(errorMessage)  
    }  
  }  
  
  // 2ë‹¨ê³„ ì„±ê³µ í›„ ë¡œê·¸ ì¶œë ¥ (ì˜ìˆ˜ì¦ ê²€ì¦ì€ ë³„ë„ ì²˜ë¦¬)  
  const handleSecondStepSuccess = async (result: PurchaseResult) => {  
    console.log('2ë‹¨ê³„ êµ¬ê¸€ ê²°ì œ ì„±ê³µ:', result)  
  }  
  
  // âœ… ì˜ìˆ˜ì¦ ê²€ì¦ ì²˜ë¦¬ (3ë‹¨ê³„) - ì„±ê³µ ì‹œ ì™„ì „í•œ ìƒíƒœ ì´ˆê¸°í™” ì ìš©  
  const handleReceiptVerification = async (result: PurchaseResult) => {  
    try {  
      console.log('ì˜ìˆ˜ì¦ ê²€ì¦ ì‹œì‘:', result)  
  
      if (!paymentInitiationResponse) {  
        throw new Error('ê²°ì œ ì´ˆê¸°í™” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      // ì˜ìˆ˜ì¦ ë°ì´í„° í•„ìˆ˜ í•„ë“œ í™•ì¸  
      if (!result.receiptData) {  
        throw new Error('ì˜ìˆ˜ì¦ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      if (!result.productId) {  
        throw new Error('ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      if (!result.basePlanId) {  
        throw new Error('ë² ì´ìŠ¤ í”Œëœ IDê°€ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      if (!result.transactionId) {  
        throw new Error('ê±°ë˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      if (!result.secretKey) {  
        throw new Error('ì‹œí¬ë¦¿ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      if (!result.fcmToken) {  
        throw new Error('FCM í† í°ì´ ì—†ìŠµë‹ˆë‹¤.')  
      }  
  
      // 3ë‹¨ê³„ ìš”ì²­ ë°ì´í„° êµ¬ì„±  
      const verificationRequest: PaymentVerificationCommonRequest = {  
        platform: result.platform as PaymentPlatformEnum,  
        receiptData: result.receiptData,  
        productId: result.productId,  
        basePlanId: result.basePlanId,  
        transactionId: result.transactionId,  
        secretKey: result.secretKey,  
        fcmToken: result.fcmToken,  
      }  
      toast.success(`ì˜ìˆ˜ì¦ ê²€ì¦ì²˜ë¦¬ ë‚´ result ${JSON.stringify(verificationRequest)}`)  
  
      console.log('ì˜ìˆ˜ì¦ ê²€ì¦ ìš”ì²­ ë°ì´í„°:', verificationRequest)  
  
      await verifyGoogleMutation.mutateAsync(verificationRequest)  
  
      // 3ë‹¨ê³„ ì„±ê³µ ì‹œ ìœ ì € ì •ë³´ ì—…ë°ì´íŠ¸  
      await queryClient.invalidateQueries({  
        queryKey: ['useGetUserInfo'],  
      })  
  
      // êµ¬ë… ë³€ê²½ì¸ì§€ ì‹ ê·œì¸ì§€ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ í‘œì‹œ  
      const changeType = selectedPaymentOption ? getSubscriptionChangeType(selectedPaymentOption) : 'new'  
      const successMessage = changeType === 'new' ? 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' : 'êµ¬ë… ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'  
  
      toast.success(successMessage)  
  
      // âœ… ê²°ì œ ì„±ê³µ ì‹œ ëª¨ë“  ìƒíƒœë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”  
      console.log('âœ… ê²°ì œ ì„±ê³µ: ëª¨ë“  ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.')  
      resetAllStates()  
      onClose()  
    } catch (error) {  
      const errorMessage = error instanceof Error ? error.message : '3ë‹¨ê³„ ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'  
      console.error('ì˜ìˆ˜ì¦ ê²€ì¦ ì‹¤íŒ¨:', error)  
      handlePaymentFailure(errorMessage)  
    }  
  }  
  
  const handlePayment = async () => {  
    if (!selectedPaymentOption) {  
      toast.error('ê²°ì œ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.')  
      return  
    }  
  
    if (!isAuthReady) {  
      toast.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.')  
      return  
    }  
  
    if (!secretKey) {  
      toast.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.')  
      return  
    }  
  
    const paymentOption = convertToPaymentOption(selectedPaymentOption)  
    if (!paymentOption) {  
      toast.error('ì˜ëª»ëœ ê²°ì œ ì˜µì…˜ì…ë‹ˆë‹¤.')  
      return  
    }  
  
    setIsPaymentProcessing(true)  
  
    try {  
      // 1ë‹¨ê³„ ìš”ì²­ ë°ì´í„° êµ¬ì„±  
      const paymentInitiationRequest = convertToPaymentInitiationRequest(selectedPaymentOption)  
  
      // 1ë‹¨ê³„ ì‹¤í–‰  
      const response = await paymentInitiateMutation.mutateAsync(paymentInitiationRequest)  
  
      // 1ë‹¨ê³„ ì„±ê³µ ì‹œ 2ë‹¨ê³„ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •  
      await handleFirstStepSuccess(response, paymentOption)  
    } catch (error) {  
      const errorMessage = error instanceof Error ? error.message : '1ë‹¨ê³„ ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'  
      handlePaymentFailure(errorMessage)  
    }  
  }  
  
  // ê²°ì œ ë²„íŠ¼ ë¹„í™œì„±í™” ì¡°ê±´ - ì‹¤ì‹œê°„ secretKey ì²´í¬  
  const isPaymentButtonDisabled = () => {  
    const disabled =  
      !selectedPaymentOption ||  
      !authInitialized ||  
      !isAuthReady ||  
      !secretKey ||  
      isPaymentProcessing ||  
      isGoogleProcessing ||  
      isAppStoreProcessing ||  
      paymentInitiateMutation.isPending ||  
      verifyGoogleMutation.isPending ||  
      !!pendingSecondStep // 2ë‹¨ê³„ ëŒ€ê¸° ì¤‘ì¼ ë•Œë„ ë¹„í™œì„±í™”  
  
    return disabled  
  }  
  
  // ê²°ì œ ë²„íŠ¼ í…ìŠ¤íŠ¸  
  const getPaymentButtonText = () => {  
    if (!authInitialized) {  
      return 'ì´ˆê¸°í™” ì¤‘...'  
    }  
  
    if (!isAuthReady) {  
      return 'ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...'  
    }  
  
    if (!selectedPaymentOption) {  
      return 'ê²°ì œ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”'  
    }  
  
    if (!secretKey) {  
      return 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'  
    }  
  
    if (paymentInitiateMutation.isPending) {  
      return '1ë‹¨ê³„ ì²˜ë¦¬ ì¤‘...'  
    }  
  
    if (pendingSecondStep) {  
      return '2ë‹¨ê³„ ì¤€ë¹„ ì¤‘...'  
    }  
  
    if (isGoogleProcessing || isAppStoreProcessing) {  
      return '2ë‹¨ê³„ ì²˜ë¦¬ ì¤‘...'  
    }  
  
    if (verifyGoogleMutation.isPending) {  
      return '3ë‹¨ê³„ ì²˜ë¦¬ ì¤‘...'  
    }  
  
    if (isPaymentProcessing) {  
      return 'ê²°ì œ ì²˜ë¦¬ ì¤‘...'  
    }  
  
    const isCurrentOptionProcessing =  
      selectedPaymentOption === googleProcessingOptionId || selectedPaymentOption === appStoreProcessingOptionId  
  
    if (isCurrentOptionProcessing) {  
      return 'ê²°ì œ ì²˜ë¦¬ ì¤‘...'  
    }  
  
    // êµ¬ë… ë³€ê²½ì¸ì§€ ì‹ ê·œ ê²°ì œì¸ì§€ì— ë”°ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½  
    const changeType = selectedPaymentOption ? getSubscriptionChangeType(selectedPaymentOption) : 'new'  
    const actionText = changeType === 'new' ? 'ê²°ì œí•˜ê¸°' : 'êµ¬ë… ë³€ê²½í•˜ê¸°'  
  
    switch (deviceType) {  
      case 'ANDROID':  
        return `Google Playë¡œ ${actionText}`  
      case 'IOS':  
        return `App Storeë¡œ ${actionText}`  
      case 'WEB':  
      default:  
        return actionText  
    }  
  }  
  
  const getSupportedPaymentMethod = () => {  
    switch (deviceType) {  
      case 'ANDROID':  
        return 'Google Play'  
      case 'IOS':  
        return 'App Store'  
      case 'WEB':  
        return 'Web Payment'  
      default:  
        return 'Unknown'  
    }  
  }  
  
  // ë””ë°”ì´ìŠ¤ ì²´í¬ í•¨ìˆ˜ë“¤ - ì´ì œ ë‹¨ìˆœíˆ deviceType ê¸°ë°˜ìœ¼ë¡œë§Œ ë™ì‘  
  const isAndroidDevice = deviceType === 'ANDROID'  
  const isIOSDevice = deviceType === 'IOS'  
  
  return {  
    // ì¸ì¦ ì •ë³´  
    secretKey,  
    isAuthReady,  
    authInitialized,  
  
    // ë””ë°”ì´ìŠ¤ ì •ë³´  
    deviceType,  
    isAndroidDevice,  
    isIOSDevice,  
    getSupportedPaymentMethod,  
  
    // ê²°ì œ ì˜µì…˜ ìƒíƒœ  
    selectedPaymentOption,  
    setSelectedPaymentOption,  
  
    // êµ¬ë… ì •ë³´  
    getSubscriptionChangeType,  
  
    // ê²°ì œ ì´ˆê¸°í™” ì‘ë‹µ  
    paymentInitiationResponse,  
  
    // ì²˜ë¦¬ ìƒíƒœ  
    isProcessing:  
      isPaymentProcessing ||  
      isGoogleProcessing ||  
      isAppStoreProcessing ||  
      paymentInitiateMutation.isPending ||  
      verifyGoogleMutation.isPending ||  
      !!pendingSecondStep, // 2ë‹¨ê³„ ëŒ€ê¸° ìƒíƒœë„ í¬í•¨  
  
    processingOptionId: googleProcessingOptionId || appStoreProcessingOptionId,  
  
    // í•¨ìˆ˜ë“¤  
    handlePayment,  
    getPaymentButtonText,  
    isPaymentButtonDisabled,  
    onClose,  
    resetPaymentState, // ì™„ì „í•œ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜  
    resetAllStates, // ì§ì ‘ì ì¸ ì™„ì „ ì´ˆê¸°í™” í•¨ìˆ˜ë„ export  }  
}
```