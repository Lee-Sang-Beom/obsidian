
```tsx
"use client";

import styles from "./ChemiMap.module.scss";
import MapContext from "@/utils/map/mapContext";
import { useContext, useEffect, useRef, useState } from "react";

import { ShelterDetailResponse } from "@/types/sub/Sm/SysShelter";
import { Session } from "next-auth";
import { chemicalSelectSearchFilter } from "@/types/common/filter/filter";
import { EnumType } from "@/types/common/commonType";
import { useAutoAlert } from "@/hooks/Alert/useAutoAlert";
import { commonSelectType } from "@/components/common/CommonSelect/CommonSelect";
import {
  CompanyMapResponse,
  SearchCompanyChemForMapCommand,
  SearchShelterForMapCommand,
  SiAndDongCountResponse,
} from "@/types/sub2/Ci/ChemiMap/ChemiMap";
import { Point } from "ol/geom";
import { Overlay } from "ol";
import {
  disposePopover,
  getAddYCoordinateNumber,
} from "@/hooks/sub2/Ci/ChemiMap/ChemiMap";
import { MdFestival } from "react-icons/md";
import Chip from "@/components/common/Chip/Chip";
import { useShelterListForMap } from "@/hooks/sub2/Ci/ChemiMap/useShelterListForMap";
import { useCompanyForMap } from "@/hooks/sub2/Ci/ChemiMap/useCompanyForMap";
import { SearchCompanyCommand } from "@/types/sub/Sm/SysCompany";
import { RiBuildingFill } from "react-icons/ri";
import { useChemForMap } from "@/hooks/sub2/Ci/ChemiMap/useChemForMap";
import { MapControl } from "@/components/common/MapControl/MapControl";
import { getVWorldLayer } from "@/types/common/map/Layer";
import { getIsLoginUser } from "@/utils/user";
import MapSide from "./MapSide";
import ChemiMapSwitch from "./ChemiMapSwitch";
import Legend from "./Legend";
import { toLonLat } from "ol/proj";
import { getBottomRight, getTopLeft } from "ol/extent";
import { useBoundaryForMap } from "@/hooks/sub2/Ci/ChemiMap/useBoundaryForMap";
import {
  getCiDongCircleAndTextLayer,
  getCiSiCircleAndTextLayer,
  getMaxZoomReturnCiDongLayer,
  returnSettingCiChemMarkerVectorLayer,
  returnSettingCiCompanyMarkerVectorLayer,
  returnSettingCiShelterMarkerVectorLayer,
} from "@/utils/map/sub2/Ci/layer/ciLayer";
import LoadingPopup from "@/components/common/LoadingPopup/LoadingPopup";

interface ParamsProps {
  params?: {};
  searchParams?: {
    active?: number;
    seq?: number;
    name?: string;
  };
}

interface IProps {
  companySelectTypeFilterList: EnumType<string>[];
  session: Session | null;
  params?: ParamsProps;
  shelterTotalElements: number;
  companyTotalElements: number;
  chemCompanyTotalElements: number;
  siAndDongData: SiAndDongCountResponse[];
  changwonBoundingBoxData: any;
}

export default function ChemiMap({
  companySelectTypeFilterList,
  session,
  params,
  shelterTotalElements,
  companyTotalElements,
  chemCompanyTotalElements,
  siAndDongData,
  changwonBoundingBoxData,
}: IProps) {
  const { setIsChange, setText, setStatus } = useAutoAlert();
  const [isAdmin, setIsAdmin] = useState<boolean>(false);
  const [isLoading, setIsLoading] = useState<boolean>(false);

  const { mapObj } = useContext<any>(MapContext);
  const { map } = mapObj;

  const [isMounted, setIsMounted] = useState(false);

  // 리스트 닫기
  const [open, setOpen] = useState<boolean>(true);

  // 활성화된 탭 인덱스 위치
  const [activeIdx, setActiveIdx] = useState<number>(
    params && params.searchParams && params.searchParams.active
      ? Number(params.searchParams.active)
      : 0
  );

  // 2023-05-20 추가 : 범례 확인여부
  const [isLegendClick, setIsLegendClick] = useState<boolean>(false);
  const legendRef = useRef<HTMLButtonElement>(null);

  // 2024-05-20 추가 : 맵 바운더리 박스
  const [bbox, setBbox] = useState<string | undefined>(undefined);
  const [zoomLevel, setZoomLevel] = useState<number>(14.5);
  // const boundaryQuery = useBoundaryForMap(bbox, zoomLevel);

  const [isCompelteSearch, setIsCompelteSearch] = useState(false);

  // 시에 대한 원을 그리기 위한 데이터
  const [siGeometryData, setSiGeometryData] = useState<
    SiAndDongCountResponse | undefined
  >(undefined);

  // 동에 대한 원을 그리기 위한 데이터
  const [dongGeometryData, setDongGeometryData] = useState<
    SiAndDongCountResponse[] | undefined
  >(undefined);

  // 어떤 동을 표시할 것인지에 대한 필터
  const [polygonGeometryData, setPolygonGeometryData] = useState<string[]>([]);

  // 동이 이미 레이어에 올라가있는지 확인
  const [isStackDongPolygon, setIsStackDongPolygon] = useState<boolean>(false);
  // 동을 레이어에 올려야 하는지 확인
  const [isNeedStackDongPolygon, setIsNeedStackDongPolygon] =
    useState<boolean>(false);

  /**
   * 1. 화학물질 조회 (로그인 권한자 표시, 해당 화학물질 취급하는 위치(업체)표시: 바뀔수있음)
   * @chemSearchType : 화학물질 검색 필터로 사용될 데이터
   * @chemSearchKeyWord : 검색 키워드(화학물질)를 관리할 state
   * @chemSearchKeyObj : 화학물질의 queryInstance
   *
   * @clickedMarkerChemInfoData : 클릭된 화학물질 마커가 무엇인지를 관리하는 state
   */
  const chemSearchTypeList = chemicalSelectSearchFilter;
  const [selectChemSearchFilter, setSelectChemSearchFilter] =
    useState<commonSelectType>({
      name: "전체",
      value: "ALL",
      group: "",
    });
  const [chemSearchKeyWord, setChemSearchKeyWord] = useState<string>(
    params &&
      params.searchParams &&
      params.searchParams.name &&
      params.searchParams.active &&
      Number(params.searchParams.active) == 2
      ? decodeURIComponent(params.searchParams.name)
      : ""
  );
  const [chemSearchKeyObj, setChemSearchKeyObj] =
    useState<SearchCompanyChemForMapCommand>({
      page: 0,
      size: chemCompanyTotalElements,
      searchKeyWord:
        params &&
        params.searchParams &&
        params.searchParams.name &&
        params.searchParams.active &&
        Number(params.searchParams.active) == 2
          ? decodeURIComponent(params.searchParams.name)
          : "",
      orderBy: "ASC",
      sort: "companyNm",
      chemSearchType: "ALL",
      evacMttrYn: "N",
      acdntMttrYn: "N",
    });

  const chemQuery = useChemForMap(chemSearchKeyObj);
  const [chemMarkerList, setChemMarkerList] = useState<CompanyMapResponse[]>(
    []
  );
  const [clickedMarkerChemInfoData, setClickedMarkerChemInfoData] =
    useState<CompanyMapResponse | null>(null);

  const [changeChemCompanyTabTag, setChangeChemCompanyTabTag] =
    useState<boolean>(false);

  /**
   * 2. 취급업체 조회
   * @companySearchFilter : 취급업체 검색필터로 사용될 타입 데이터 리스트
   * @selectCompanySearchFilter : 선택한 검색필터 타입
   * @companySearchKeyWord : 검색 키워드(취급업체)를 관리할 state
   * @companySearchKeyObj : 취금업체의 queryInstance
   * @companyQuery : react-query(취급업체 정보)
   * @companyMarkerList : companyQuery.data.content가 보관될 state. 조회한 취급업체 리스트들을 저장하고, 취급업체 마커를 만들기 위해 사용될 것임
   * @companyMarker : companyMarkerList에 들어간 데이터를 이용해 실질적으로 만든 마커 데이터
   * @clickedMarkerCompanyInfoData : 클릭된 취급업체 마커가 무엇인지를 관리하는 state
   */
  const [companySearchFilter, setCompanySearchFilter] = useState<
    commonSelectType[]
  >([]);

  const [selectCompanySearchFilter, setSelectCompanySearchFilter] =
    useState<commonSelectType>({
      name: "",
      value: "",
      group: "",
    });

  const [companySearchKeyWord, setCompanySearchKeyWord] = useState<string>(
    params &&
      params.searchParams &&
      params.searchParams.name &&
      params.searchParams.active &&
      Number(params.searchParams.active) == 1
      ? decodeURIComponent(params.searchParams.name)
      : ""
  );
  const [companySearchKeyObj, setCompanySearchKeyObj] =
    useState<SearchCompanyCommand>({
      page: 0,
      size: companyTotalElements,
      companySearchType: "ALL",
      searchKeyWord:
        params &&
        params.searchParams &&
        params.searchParams.name &&
        params.searchParams.active &&
        Number(params.searchParams.active) == 1
          ? decodeURIComponent(params.searchParams.name)
          : "",
      orderBy: "ASC",
      sort: "companyNm",
      evacMttrYn: "N",
      acdntMttrYn: "N",
    });
  const companyQuery = useCompanyForMap(
    companySearchKeyObj,
    getIsLoginUser(session)
  );
  const [companyMarkerList, setCompanyMarkerList] = useState<
    CompanyMapResponse[]
  >([]);

  const [clickedMarkerCompanyInfoData, setClickedMarkerCompanyInfoData] =
    useState<CompanyMapResponse | null>(null);

  const [changeCompanyTabTag, setChangeCompanyTabTag] =
    useState<boolean>(false);

  /**
   * 3. 대피소
   * @shelterSearchFilter : 대피소검색필터로 사용될 시군구 데이터 리스트
   * @selectShelterSearchFilter : default 시군구 데이터와 사용자가 선택한 시군구 데이터를 관리할 state
   * @shelterSearchKeyWord : 검색 키워드(대피소)를 관리할 state
   * @shelterSearchKeyObj : 대피소의 queryInstance
   * @shelterQuery : react-query(대피소 정보)
   * @shelterMarkerList : shelterQuery.data.content가 보관될 state. 조회한 대피소 리스트들을 저장하고, 대피소 마커를 만들기 위해 사용될 것임
   * @shelterMarker : shelterMarkerList에 들어간 데이터를 이용해 실질적으로 만든 마커 데이터
   * @clickedMarkerShelterInfoData : 클릭된 대피소 마커가 무엇인지를 관리하는 state
   *
   */
  const [shelterSearchFilter, setShelterSearchFilter] = useState<
    commonSelectType[]
  >([
    { name: "전체", value: "ALL", group: "" },
    { name: "대피소명", value: "SHELTER_NM", group: "" },
    { name: "도로명주소", value: "ROAD_NM_ADDR", group: "" },
  ]);
  const [selectShelterSearchFilter, setSelectShelterSearchFilter] =
    useState<commonSelectType>({
      name: "전체",
      value: "ALL",
      group: "",
    });

  const [shelterSearchKeyWord, setShelterSearchKeyWord] = useState<string>(
    params &&
      params.searchParams &&
      params.searchParams.name &&
      params.searchParams.active &&
      Number(params.searchParams.active) == 0
      ? params.searchParams.name
      : ""
  );
  const [shelterSearchKeyObj, setShelterSearchKeyObj] =
    useState<SearchShelterForMapCommand>({
      page: 0,
      size: shelterTotalElements,
      shelterForMapSearchType: "ALL",
      searchKeyWord:
        params &&
        params.searchParams &&
        params.searchParams.name &&
        params.searchParams.active &&
        Number(params.searchParams.active) == 0
          ? params.searchParams.name
          : "",
      orderBy: "ASC",
      sort: "shelterNm",
    });
  const shelterQuery = useShelterListForMap(shelterSearchKeyObj);
  const [shelterMarkerList, setShelterMarkerList] = useState<
    ShelterDetailResponse[]
  >([]);

  const [clickedMarkerShelterInfoData, setClickedMarkerShelterInfoData] =
    useState<ShelterDetailResponse | null>(null);

  const handleMarkerClick = (event: any) => {
    const clickedFeature = map.forEachFeatureAtPixel(
      event.pixel,
      (feature: any) => feature
    );

    if (clickedFeature) {
      // 여기에서 clickedFeature에서 필요한 정보를 추출하고 상태를 업데이트합니다.
      const markerName = clickedFeature.get("geometryName");

      if (activeIdx === 0 && shelterMarkerList.length) {
        const clickMarkerData = shelterMarkerList.find((item) => {
          return item.shelterNm === markerName;
        });
        setClickedMarkerShelterInfoData(clickMarkerData!);
        return;
      }

      if (activeIdx === 1 && companyMarkerList.length) {
        const clickMarkerData = companyMarkerList.find((item) => {
          return item.companyNm === markerName;
        });
        setClickedMarkerCompanyInfoData(clickMarkerData!);
        return;
      }

      if (activeIdx === 2 && chemMarkerList.length) {
        const clickMarkerData = chemMarkerList.find((item) => {
          return item.companyNm === markerName;
        });
        setClickedMarkerChemInfoData(clickMarkerData!);
        return;
      }
    }
  };

  /**
   *
   * 4. 공통 함수 및 useEffect
   * @handleMarkerClick : 마커 클릭 시 발생하는 이벤트
   * @useEffect (4-1) : 해당 페이지에 접근한 사용자가 관리자인지 아닌지 판단
   * @useEffect (4-2) : 최초 렌더링 시, 대피소 기본 select박스 시군구 필터 데이터 세팅
   * @useEffect (4-3) : tabIndex가 변할때마다, queryInstance가 변하거나, query로 넘어온 데이터가 변할때마다, marker를 생성할 리스트를 새로 갱신
   * @useEffect (4-4) : 화면 첫 렌더링 시 map 객체를 초기화 + layer/style 초기화
   * @useEffect (4-5) : activeIndex 및 markerList가 변할 때마다 마커를포함한 vectorLayer를 초기화하고, 다시 마커를 포함한 vectorLayor를 그리는 역할 수행
   * @useEffect (4-6) : 2024-05-20 추가 > 동 polygon 그리기 관리
   * @useEffect (4-7) : 2024-05-20 추가 > 로딩 관리
   * @useEffect (4-8) : 2024-05-20 추가 > activeIdx, zoomLevel에 따른 취급업체, 화학물질 마커 추가/삭제 관리
   */

  useEffect(() => {
    if (siAndDongData) {
      const siData = siAndDongData.find((item) => {
        return item.stdgNm === "창원시";
      });
      const dongData = siAndDongData.filter((item) => {
        return item.stdgNm !== "창원시";
      });
      const polygonDongData = dongData
        .filter((item) => {
          return item.acdntMttrCnt && item.acdntMttrCnt >= 15;
        })
        .map((item) => {
          return item.stdgNm;
        });
      setSiGeometryData(siData || undefined);
      setDongGeometryData(dongData || undefined);

      setPolygonGeometryData(polygonDongData || []);
    }
  }, [siAndDongData]);
  // 4-1)
  useEffect(() => {
    if (session && session.user) {
      setIsAdmin(true);
    } else {
      setIsAdmin(false);
    }
  }, [session]);

  // 4-2)
  useEffect(() => {
    if (companySelectTypeFilterList.length) {
      const filtedCommonSelectTypeList = companySelectTypeFilterList.map(
        (item) => {
          return {
            name: item.name,
            value: item.type,
            group: "",
          };
        }
      );

      const filtedDefaultSelectType = filtedCommonSelectTypeList.find(
        (item) => {
          return item.name === "전체";
        }
      );

      // 총 리스트
      setCompanySearchFilter(filtedCommonSelectTypeList);

      // 디폴트
      setSelectCompanySearchFilter(filtedDefaultSelectType!);
    }
  }, []);

  // 4-3)
  useEffect(() => {
    // 1. 화학물질
    if (chemQuery && chemQuery.data && chemQuery.data.content) {
      setChemMarkerList(chemQuery.data.content);
    } else {
      setChemMarkerList([]);
    }
    // 2. 취급업체
    if (companyQuery && companyQuery.data && companyQuery.data.content) {
      setCompanyMarkerList(companyQuery.data.content);
    } else {
      setCompanyMarkerList([]);
    }
    // 3. 대피소
    if (shelterQuery && shelterQuery.data && shelterQuery.data.content) {
      setShelterMarkerList(shelterQuery.data.content);
    } else {
      setShelterMarkerList([]);
    }
  }, [
    activeIdx,
    chemSearchKeyObj,
    shelterSearchKeyObj,
    companySearchKeyObj,
    chemQuery.data,
    shelterQuery.data,
    companyQuery.data,
  ]);

  // 4-4)
  useEffect(() => {
    const element: HTMLElement | null = document.getElementById("popup");

    // 초기화작업
    setIsMounted(true);

    // 최초 로드 시, BaseLayer 추가
    const vworld = getVWorldLayer();

    if (map) {
      // 팝업 띄우기

      // 기존 맵 객체 존재 시, default로 작동할 BaseLayer를 map에 add
      map.addLayer(vworld);
      map.getAllLayers().map((m: any) => {
        if (
          m.get("name") &&
          (m.get("name") === "base-vworld-Satellite" ||
            m.get("name") === "base-vworld-hybrid")
        ) {
          map.removeLayer(m);
        }
        return;
      });

      map.on("movestart", function (e: any) {});

      map.on("pointermove", function (e: any) {
        const pixel = map.getEventPixel(e.originalEvent);
        const hit = map.hasFeatureAtPixel(pixel);

        const feature = map.forEachFeatureAtPixel(
          e.pixel,
          function (feature: any) {
            // 감지되지 않으면 null 반환
            return feature;
          }
        );

        // 만약 못찾으면(클릭된 위치에서 맵에 존재하는 feature가 없으면), return
        if (
          feature &&
          (feature.values_.geomertyName === "dong_polygon" ||
            feature.values_.geomertyName === "middleZoomLevelFeature")
        ) {
          map.getTarget().style.cursor = "";
        } else {
          map.getTarget().style.cursor = hit ? "pointer" : "";
        }

        map.getTarget().style.zIndex = 9999;
      });

      map.on("moveend", (evt: any) => {
        const map = evt.map;
        const extent = map.getView().calculateExtent(map.getSize());
        const bottomRight = toLonLat(getBottomRight(extent));
        const topLeft = toLonLat(getTopLeft(extent));

        // 창원시는 lot(경도) 128.6401544, lat(위도) 35.2540033
        const boxObj = {
          lat1: topLeft[1].toString(),
          lat2: bottomRight[1].toString(),
          lot1: topLeft[0].toString(),
          lot2: bottomRight[0].toString(),
        };

        setBbox(() => {
          return `${boxObj.lot1},${boxObj.lat2},${boxObj.lot2},${boxObj.lat1}`;
        });
      });

      map.getView().on("change:resolution", () => {
        if (element) {
          const curZoomLevel = map.getView().getZoom();

          if (curZoomLevel !== zoomLevel) {
            setZoomLevel(curZoomLevel);
          }

          element!.style.display = "none";
        }
      });

      if (element) {
        let popover: any;
        element!.style.display = "none";

        // OpenLayers의 Overlay 클래스를 사용하여 새로운 팝업 객체를 생성
        // 팝업이 표시될 위치, 이벤트 처리 방법 등을 설정
        const popup = new Overlay({
          element: element!,
          positioning: "bottom-center",
          stopEvent: true, // map.on("click")으로의 뷰포트 이벤트까지 이동시킬건지 아닌지 (true로하면, map의 clickevent까지 발생하지않음)
        });

        map!.addOverlay(popup);
        map!.on("click", function (evt: any) {
          // 사용자가 맵 클릭하면, 일단 팝업을 없앰

          disposePopover(popover, element);

          // 클릭한 픽셀 위치에서 맵에 존재하는 feature(지도의 특정 객체)를 찾음.
          // pixel, callback func, option
          const feature = map.forEachFeatureAtPixel(
            evt.pixel,
            function (feature: any) {
              // 감지되지 않으면 null 반환
              return feature;
            }
          );

          // 만약 못찾으면(클릭된 위치에서 맵에 존재하는 feature가 없으면), return
          if (
            !feature ||
            (feature &&
              (feature.values_.geomertyName === "dong_polygon" ||
                feature.values_.geomertyName === "middleZoomLevelFeature"))
          ) {
            element!.style.display = "none";
            return;
          } else {
            const curZoomLevel = map.getView().getZoom();
            if (!curZoomLevel) {
              // 줌 레벨을 얻어오지 못하면, 맵을 사용하지 못하는 상태임
              return;
            }
            const markerCoordinate = feature!.getGeometry().getCoordinates();
            const addYCoordinateNumber = getAddYCoordinateNumber(curZoomLevel);

            popup.setPosition([
              markerCoordinate[0],
              markerCoordinate[1] + addYCoordinateNumber,
            ]);

            // popup.setPosition(evt.coordinate);
            element!.style.display = "block";
          }
        });
      }
    }
  }, [map]);

  // 4-5)
  useEffect(() => {
    if (!isMounted || !map || !siGeometryData || !dongGeometryData) {
      return;
    }

    map.on("click", handleMarkerClick);

    // 레이어 추가 전, 모든 레이어 제거
    map.getAllLayers().map((m: any) => {
      if (
        m.get("name") &&
        (m.get("name") === "shelter" ||
          m.get("name") === "company" ||
          m.get("name") === "company_circle" ||
          m.get("name") === "chem" ||
          m.get("name") === "chem_circle")
      ) {
        map.removeLayer(m);
      }
    });
    const element = document.getElementById("popup");
    element!.style.display = "none";

    // tabIndex 먼저 확인
    // 각 tabIndex(대피소, 취급업체, 화학물질)에 해당하는 레이어를 추가만 해주면 됨!!
    if (activeIdx == 0) {
      if (shelterMarkerList.length) {
        const newShelterMarkerVectorLayerList =
          returnSettingCiShelterMarkerVectorLayer(shelterMarkerList, "shelter");

        map.addLayer(newShelterMarkerVectorLayerList);

        if (
          // 검색어가 있고 다른 페이지에서 접근한 경우
          (params &&
            params.searchParams &&
            params.searchParams.active &&
            Number(params.searchParams.active) == 0 &&
            shelterSearchKeyWord.length > 0) ||
          // 검색어가 있고 검색결과가 있는 경우
          (shelterSearchKeyWord.length > 0 &&
            shelterMarkerList &&
            shelterMarkerList[0].lot &&
            shelterMarkerList[0].lat)
        ) {
          map.getView().setCenter(
            new Point([
              Number(shelterMarkerList[0].lot),
              Number(shelterMarkerList[0].lat),
            ])
              .transform("EPSG:4326", "EPSG:3857")
              // @ts-ignore
              .getCoordinates()
          );
          map.getView().setZoom(14.5);
        } else {
          map.getView().setCenter(
            new Point([128.679315, 35.22783])
              .transform("EPSG:4326", "EPSG:3857")
              // @ts-ignore
              .getCoordinates()
          );
          map.getView().setZoom(14.5);
        }
        // 데이터의 맨 첫번째 요소로 자동 포커스이동!!
      }
    } else if (activeIdx == 1) {
      if (companyMarkerList.length) {
        if (
          // 검색어가 있고 다른 페이지에서 접근한 경우
          (params &&
            params.searchParams &&
            params.searchParams.active &&
            Number(params.searchParams.active) == 1 &&
            companySearchKeyWord.length > 0) ||
          // 검색어가 있고 검색결과가 있는 경우
          (companySearchKeyWord.length > 0 &&
            companyMarkerList &&
            companyMarkerList[0].lot &&
            companyMarkerList[0].lat) ||
          // 검색어가 없고 주민대피물질/사고대비물질 기준 토글이 발생하는 경우
          ((companySearchKeyObj.acdntMttrYn == "Y" ||
            companySearchKeyObj.evacMttrYn == "Y") &&
            companyMarkerList &&
            companyMarkerList[0].lot &&
            companyMarkerList[0].lat) ||
          // 탭이 바뀔 때
          (changeCompanyTabTag &&
            companyMarkerList &&
            companyMarkerList[0].lot &&
            companyMarkerList[0].lat)
        ) {
          setChangeCompanyTabTag(false);

          // setIsCompelteSearch(true);
          // 데이터의 맨 첫번째 요소로 자동 포커스이동!!
          map.getView().setCenter(
            new Point([
              Number(companyMarkerList[0].lot),
              Number(companyMarkerList[0].lat),
            ])
              .transform("EPSG:4326", "EPSG:3857")
              // @ts-ignore
              .getCoordinates()
          );
          map.getView().setZoom(14.5);
        } else {
          map.getView().setCenter(
            new Point([128.679315, 35.22783])
              .transform("EPSG:4326", "EPSG:3857")
              // @ts-ignore
              .getCoordinates()
          );
          map.getView().setZoom(14.5);
        }

        // 14.5 이상일 때 호출
        if (zoomLevel >= 14.5) {
          const newCompanyMarkerVectorLayerList =
            returnSettingCiCompanyMarkerVectorLayer(
              companyMarkerList,
              "company"
            );
          map.addLayer(newCompanyMarkerVectorLayerList);
        } else if (zoomLevel > 12.5 && zoomLevel < 14.5) {
          // 동 정보 표시
          const CiCircleAndTextLayerList = getCiDongCircleAndTextLayer(
            dongGeometryData!,
            "company_circle"
          );
          map.addLayer(CiCircleAndTextLayerList);
        } else {
          // 시 정보 표시
          const CiCircleAndTextLayerList = getCiSiCircleAndTextLayer(
            "company_circle",
            siGeometryData!.companyCnt || 0
          );
          map.addLayer(CiCircleAndTextLayerList);
        }
      }
    } else if (activeIdx == 2) {
      if (chemMarkerList.length) {
        if (
          // 검색어가 있고 다른 페이지에서 접근한 경우
          (params &&
            params.searchParams &&
            params.searchParams.active &&
            Number(params.searchParams.active) == 2 &&
            chemSearchKeyWord.length > 0) || // 검색어가 있고 검색결과가 있는 경우
          (chemSearchKeyWord.length > 0 &&
            chemMarkerList &&
            chemMarkerList[0].lot &&
            chemMarkerList[0].lat) ||
          // 검색어가 없고 주민대피물질/사고대비물질 기준 토글이 발생하는 경우
          ((chemSearchKeyObj.acdntMttrYn == "Y" ||
            chemSearchKeyObj.evacMttrYn == "Y") &&
            chemMarkerList &&
            chemMarkerList[0].lot &&
            chemMarkerList[0].lat) ||
          // 탭이 바뀔 때
          (changeChemCompanyTabTag &&
            chemMarkerList &&
            chemMarkerList[0].lot &&
            chemMarkerList[0].lat)
        ) {
          setChangeChemCompanyTabTag(false);
          // setIsCompelteSearch(true);
          // 데이터의 맨 첫번째 요소로 자동 포커스이동!!
          map.getView().setCenter(
            new Point([
              Number(chemMarkerList[0].lot),
              Number(chemMarkerList[0].lat),
            ])
              .transform("EPSG:4326", "EPSG:3857")
              // @ts-ignore
              .getCoordinates()
          );
          map.getView().setZoom(14.5);
        } else {
          map.getView().setCenter(
            new Point([128.679315, 35.22783])
              .transform("EPSG:4326", "EPSG:3857")
              // @ts-ignore
              .getCoordinates()
          );
          map.getView().setZoom(14.5);
        }

        // 14.5 이상일 때 호출
        if (zoomLevel >= 14.5) {
          const newChemMarkerVectorLayerList =
            returnSettingCiChemMarkerVectorLayer(chemMarkerList, "chem");
          map.addLayer(newChemMarkerVectorLayerList);
        } else if (zoomLevel > 12.5 && zoomLevel < 14.5) {
          // 동 정보 표시
          const CiCircleAndTextLayerList = getCiDongCircleAndTextLayer(
            dongGeometryData!,
            "chem_circle"
          );
          map.addLayer(CiCircleAndTextLayerList);
        } else {
          // 시 정보 표시
          const CiCircleAndTextLayerList = getCiSiCircleAndTextLayer(
            "chem_circle",
            siGeometryData!.companyCnt || 0
          );
          map.addLayer(CiCircleAndTextLayerList);
        }
      }
    } else {
    }

    return () => {
      map.un("click", handleMarkerClick);
    };
  }, [
    activeIdx,
    chemMarkerList,
    shelterMarkerList,
    companyMarkerList,
    siGeometryData,
    dongGeometryData,
  ]);

  // 4-6)
  useEffect(() => {
    if (!map) return;

    if (
      activeIdx !== 0 &&
      changwonBoundingBoxData &&
      polygonGeometryData &&
      zoomLevel >= 14.5 &&
      zoomLevel <= 17 &&
      !isStackDongPolygon &&
      isNeedStackDongPolygon
    ) {
      const filtedboundaryData = changwonBoundingBoxData.filter((item: any) => {
        // 각 item이 위험구역으로 분류된 filterDongNmList에 있는 요소인지 확인 (includes 메소드는 true / false를 반환한다.)
        return polygonGeometryData.includes(item.properties.emd_kor_nm);
      });

      const coordinateList = filtedboundaryData.map((item: any) => {
        return item.geometry.coordinates;
      });

      if (activeIdx === 1 || activeIdx === 2) {
        coordinateList.map((coordinateSubList: any, idx: number) => {
          coordinateSubList.map((coordinate: any, idx2: number) => {
            const companyDongList = getMaxZoomReturnCiDongLayer(
              coordinate,
              "dong_polygon"
            );

            map.addLayer(companyDongList);
          });
        });

        setIsNeedStackDongPolygon(false); // 그렸기에 더 그리지 않아도됨
        setIsStackDongPolygon(true); // 레이어에 추가됨
      }
    }
  }, [
    activeIdx,
    polygonGeometryData,
    changwonBoundingBoxData,
    isNeedStackDongPolygon,
  ]);

  // 4-7)
  useEffect(() => {
    setTimeout(() => {
      // 대피소
      if (activeIdx === 0) {
        if (shelterQuery.isLoading) {
          setIsLoading(true);
        } else {
          setIsLoading(false);
        }
      }
      // 취급업체
      else if (activeIdx === 1) {
        if (companyQuery.isLoading) {
          setIsLoading(true);
        } else {
          setIsLoading(false);
        }
      }
      // 화학물질
      else {
        if (chemQuery.isLoading) {
          setIsLoading(true);
        } else {
          setIsLoading(false);
        }
      }
    }, 250);
  }, [
    activeIdx,
    chemQuery.isLoading,
    shelterQuery.isLoading,
    companyQuery.isLoading,
  ]);

  // 4-8)
  useEffect(() => {
    if (!map || !dongGeometryData || !siGeometryData) return;
    // 레이어 추가 전, 모든 레이어 제거

    // map.getAllLayers().map((m: any) => {
    //   if (
    //     m.get("name") &&
    //     (m.get("name") === "company" ||
    //       m.get("name") === "chem" ||
    //       m.get("name") === "company_circle" ||
    //       m.get("name") === "chem_circle")
    //   ) {
    //     map.removeLayer(m);
    //   }
    // });

    if (zoomLevel >= 14.5) {
      if (activeIdx === 1) {
        let isNeedStack = false;

        // company 제외 일단 제거
        map.getAllLayers().map((m: any) => {
          if (
            m.get("name") &&
            (m.get("name") === "chem" ||
              m.get("name") === "company_circle" ||
              m.get("name") === "chem_circle" ||
              m.get("name") === "company_si_circle" ||
              m.get("name") === "chem_si_circle")
          ) {
            map.removeLayer(m);
          }
        });

        map.getAllLayers().map((m: any) => {
          if (m.get("name") && m.get("name") === "company") {
            isNeedStack = true;
          }
        });

        if (!isNeedStack) {
          // 취급업체
          const newCompanyMarkerVectorLayerList =
            returnSettingCiCompanyMarkerVectorLayer(
              companyMarkerList,
              "company"
            );

          map.addLayer(newCompanyMarkerVectorLayerList);
        }
      } else if (activeIdx === 2) {
        let isNeedStack = false;

        // chem 제외 일단 제거
        map.getAllLayers().map((m: any) => {
          if (
            m.get("name") &&
            (m.get("name") === "company" ||
              m.get("name") === "company_circle" ||
              m.get("name") === "chem_circle" ||
              m.get("name") === "company_si_circle" ||
              m.get("name") === "chem_si_circle")
          ) {
            map.removeLayer(m);
          }
        });

        map.getAllLayers().map((m: any) => {
          if (m.get("name") && m.get("name") === "chem") {
            isNeedStack = true;
          }
        });

        if (!isNeedStack) {
          // 화학물질
          const newChemMarkerVectorLayerList =
            returnSettingCiChemMarkerVectorLayer(chemMarkerList, "chem");
          map.addLayer(newChemMarkerVectorLayerList);
        }
      } else {
      }
    } else if (zoomLevel > 12.5 && zoomLevel < 14.5) {
      // 동이 어디있는지 circle로 표시
      if (activeIdx === 1) {
        let isNeedStack = false;

        // company_circle 제외 일단 제거
        map.getAllLayers().map((m: any) => {
          if (
            m.get("name") &&
            (m.get("name") === "chem" ||
              m.get("name") === "company" ||
              m.get("name") === "chem_circle" ||
              m.get("name") === "company_si_circle" ||
              m.get("name") === "chem_si_circle")
          ) {
            map.removeLayer(m);
          }
        });

        map.getAllLayers().map((m: any) => {
          if (m.get("name") && m.get("name") === "company_circle") {
            isNeedStack = true;
          }
        });

        if (!isNeedStack) {
          // 취급업체
          const CiCircleAndTextLayerList = getCiDongCircleAndTextLayer(
            dongGeometryData,
            "company_circle"
          );
          map.addLayer(CiCircleAndTextLayerList);
        }
      } else if (activeIdx === 2) {
        let isNeedStack = false;

        // chem_circle 제외 일단 제거
        map.getAllLayers().map((m: any) => {
          if (
            m.get("name") &&
            (m.get("name") === "chem" ||
              m.get("name") === "company" ||
              m.get("name") === "company_circle" ||
              m.get("name") === "company_si_circle" ||
              m.get("name") === "chem_si_circle")
          ) {
            map.removeLayer(m);
          }
        });

        map.getAllLayers().map((m: any) => {
          if (m.get("name") && m.get("name") === "chem_circle") {
            isNeedStack = true;
          }
        });

        if (!isNeedStack) {
          // 화학물질
          const CiCircleAndTextLayerList = getCiDongCircleAndTextLayer(
            dongGeometryData,
            "chem_circle"
          );
          map.addLayer(CiCircleAndTextLayerList);
        }
      } else {
      }
    } else {
      // 창원시가 어디있는지 circle로 표시
      if (activeIdx === 1) {
        let isNeedStack = false;

        // company_circle 제외 일단 제거
        map.getAllLayers().map((m: any) => {
          if (
            m.get("name") &&
            (m.get("name") === "chem" ||
              m.get("name") === "company" ||
              m.get("name") === "company_circle" ||
              m.get("name") === "chem_circle" ||
              m.get("name") === "chem_si_circle")
          ) {
            map.removeLayer(m);
          }
        });

        map.getAllLayers().map((m: any) => {
          if (m.get("name") && m.get("name") === "company_si_circle") {
            isNeedStack = true;
          }
        });

        if (!isNeedStack) {
          // 취급업체
          const CiCircleAndTextLayerList = getCiSiCircleAndTextLayer(
            "company_si_circle",
            siGeometryData.companyCnt
          );
          map.addLayer(CiCircleAndTextLayerList);
        }
      } else if (activeIdx === 2) {
        let isNeedStack = false;

        // chem_circle 제외 일단 제거
        map.getAllLayers().map((m: any) => {
          if (
            m.get("name") &&
            (m.get("name") === "chem" ||
              m.get("name") === "company" ||
              m.get("name") === "company_circle" ||
              m.get("name") === "chem_circle" ||
              m.get("name") === "company_si_circle")
          ) {
            map.removeLayer(m);
          }
        });

        map.getAllLayers().map((m: any) => {
          if (m.get("name") && m.get("name") === "chem_si_circle") {
            isNeedStack = true;
          }
        });

        if (!isNeedStack) {
          // 화학물질
          const CiCircleAndTextLayerList = getCiSiCircleAndTextLayer(
            "chem_si_circle",
            siGeometryData.companyCnt
          );
          map.addLayer(CiCircleAndTextLayerList);
        }
      } else {
      }
    }

    // 기타 : 동폴리곤

    if (zoomLevel >= 14.5 && zoomLevel <= 17 && activeIdx !== 0) {
      let isNeedStack = true;

      map.getAllLayers().map((m: any) => {
        if (m.get("name") && m.get("name") === "dong_polygon") {
          isNeedStack = false;
        }
      });

      if (isNeedStack) {
        setIsStackDongPolygon(false);
        setIsNeedStackDongPolygon(true); // 추가되어야 함
      } else {
        setIsStackDongPolygon(true);
        setIsNeedStackDongPolygon(false); // 추가되지 않아야 함
      }
    } else {
      // 레이어 추가 전, 모든 레이어 제거
      map.getAllLayers().map((m: any) => {
        if (m.get("name") && m.get("name") === "dong_polygon") {
          map.removeLayer(m);
          setIsStackDongPolygon(false); // 스택되어있지 않음
          setIsNeedStackDongPolygon(false); // 그릴 필요가 없음
        }
      });
    }
  }, [activeIdx, zoomLevel, dongGeometryData, siGeometryData]);

  return (
    <div className={styles.chemimap_wrap}>
      <LoadingPopup
        state={isLoading}
        setState={setIsLoading}
        title="검색 결과를 불러오는 중입니다."
      />
      <MapSide
        map={map}
        session={session}
        open={open}
        setOpen={setOpen}
        activeIdx={activeIdx}
        setActiveIdx={setActiveIdx}
        isAdmin={isAdmin}
        setIsCompelteSearch={setIsCompelteSearch}
        // 화학물질
        chemSearchTypeList={chemSearchTypeList}
        selectChemSearchFilter={selectChemSearchFilter}
        setSelectChemSearchFilter={setSelectChemSearchFilter}
        chemSearchKeyWord={chemSearchKeyWord}
        setChemSearchKeyWord={setChemSearchKeyWord}
        setChemSearchKeyObj={setChemSearchKeyObj}
        chemDataList={chemQuery.data}
        setChangeChemCompanyTabTag={setChangeChemCompanyTabTag}
        // 취급업체
        companySearchFilter={companySearchFilter}
        selectCompanySearchFilter={selectCompanySearchFilter}
        setSelectCompanySearchFilter={setSelectCompanySearchFilter}
        companySearchKeyWord={companySearchKeyWord}
        setCompanySearchKeyWord={setCompanySearchKeyWord}
        setCompanySearchKeyObj={setCompanySearchKeyObj}
        companyDataList={companyQuery.data}
        setChangeCompanyTabTag={setChangeCompanyTabTag}
        // 대피소
        shelterSearchFilter={shelterSearchFilter}
        selectShelterSearchFilter={selectShelterSearchFilter}
        setSelectShelterSearchFilter={setSelectShelterSearchFilter}
        shelterSearchKeyWord={shelterSearchKeyWord}
        setShelterSearchKeyWord={setShelterSearchKeyWord}
        setShelterSearchKeyObj={setShelterSearchKeyObj}
        shelterDataList={shelterQuery.data}
      />
      <MapControl map={map} />
      <ChemiMapSwitch setIsLegendClick={setIsLegendClick} ref={legendRef} />
      <Legend
        isLegendClick={isLegendClick}
        setIsLegendClick={setIsLegendClick}
        ref={legendRef}
      />
      <div id="map" className={styles.map_el}>
        {isMounted && (
          <div id="popup" className={`${styles.map_popup}`}>
            {/* 대피소 */}
            {activeIdx === 0 && clickedMarkerShelterInfoData ? (
              <>
                <div className={styles.marker_popup_top}>
                  <Chip
                    chipData={{ name: "대피소", value: "대피소", group: "" }}
                    chipLeftIcon={
                      <MdFestival
                        role="img"
                        aria-label="대피소 아이콘"
                        color="var(--gray-900)"
                        size={16}
                        style={{ marginRight: "6px" }}
                      />
                    }
                    chipStyle="round"
                    bgColor="white"
                    borderColor="blue"
                    color="blue"
                  />
                  {getIsLoginUser(session) ? (
                    <a
                      href={`/cwchemical/Sm/SysShelter/ModSysShelter/${clickedMarkerShelterInfoData.shelterSeq}`}
                    >
                      {clickedMarkerShelterInfoData!.shelterNm}
                    </a>
                  ) : (
                    <p>{clickedMarkerShelterInfoData!.shelterNm}</p>
                  )}
                </div>
                <div className={styles.marker_popup_bottom}>
                  <p>{`주소 : ${clickedMarkerShelterInfoData!.roadNmAddr}`}</p>
                  {clickedMarkerShelterInfoData!.mngInstTelno ? (
                    <p>
                      관리기관전화번호 :{" "}
                      {clickedMarkerShelterInfoData!.mngInstTelno
                        .replace(/[^0-9]/g, "")
                        .replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`)}
                    </p>
                  ) : (
                    <></>
                  )}

                  <p>
                    수용가능인원 :{" "}
                    {clickedMarkerShelterInfoData!.accpTnope.toLocaleString()}명
                  </p>
                </div>
              </>
            ) : (
              <></>
            )}

            {/* 취급업체 */}
            {activeIdx === 1 && clickedMarkerCompanyInfoData ? (
              <>
                <div className={styles.marker_popup_top}>
                  <Chip
                    chipData={
                      clickedMarkerCompanyInfoData.tagType.type === "EVACUATION"
                        ? {
                            name: "주민대피물질",
                            value: "주민대피물질",
                            group: "",
                          }
                        : clickedMarkerCompanyInfoData.tagType.type ===
                          "ACDNT_PREP"
                        ? {
                            name: "사고대비물질",
                            value: "사고대비물질",
                            group: "",
                          }
                        : {
                            name: "취급업체(기타)",
                            value: "취급업체(기타)",
                            group: "",
                          }
                    }
                    borderColor={
                      clickedMarkerCompanyInfoData.tagType.type == "EVACUATION"
                        ? `var(--alert-er)`
                        : clickedMarkerCompanyInfoData.tagType.type ==
                          "ACDNT_PREP"
                        ? `#ff4c00`
                        : `#ff9933`
                    }
                    color={
                      clickedMarkerCompanyInfoData.tagType.type == "EVACUATION"
                        ? `var(--alert-er)`
                        : clickedMarkerCompanyInfoData.tagType.type ==
                          "ACDNT_PREP"
                        ? `#ff4c00`
                        : `#ff9933`
                    }
                    chipLeftIcon={
                      <RiBuildingFill
                        role="img"
                        aria-label="취급업체 아이콘"
                        color="var(--gray-900)"
                        size={16}
                      />
                    }
                    chipStyle="round"
                    bgColor="white"
                  />
                  {getIsLoginUser(session) ? (
                    <a
                      href={`/cwchemical/Sm/SysCompany/${clickedMarkerCompanyInfoData.companySeq}/modi`}
                    >
                      {clickedMarkerCompanyInfoData!.companyNm}
                    </a>
                  ) : (
                    <p>{clickedMarkerCompanyInfoData!.companyNm}</p>
                  )}
                </div>
                <div className={styles.marker_popup_bottom}>
                  <p>{`주소 : ${clickedMarkerCompanyInfoData!.roadNmAddr}`}</p>
                  {clickedMarkerCompanyInfoData!.tpbizNm ? (
                    <p>업종 : {clickedMarkerCompanyInfoData!.tpbizNm}</p>
                  ) : (
                    <></>
                  )}

                  {isAdmin ? (
                    <>
                      {clickedMarkerCompanyInfoData!.telNo ? (
                        <p>
                          연락처 :{" "}
                          {clickedMarkerCompanyInfoData!.telNo
                            .replace(/[^0-9]/g, "")
                            .replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`)}
                        </p>
                      ) : (
                        <></>
                      )}
                      {clickedMarkerCompanyInfoData!.yearTrtmntSz ? (
                        <p>
                          연간취급량 :{" "}
                          {clickedMarkerCompanyInfoData!.yearTrtmntSz}
                          {`(톤)`}
                        </p>
                      ) : (
                        <></>
                      )}
                      {clickedMarkerCompanyInfoData!.companyChemResponseList &&
                      clickedMarkerCompanyInfoData.companyChemResponseList
                        .length ? (
                        <p>
                          {" "}
                          {`취급물질명 : ${
                            clickedMarkerCompanyInfoData
                              .companyChemResponseList[0].chemResponse.mttrnmeng
                          }${
                            clickedMarkerCompanyInfoData
                              .companyChemResponseList[0].chemResponse.mttrnmkor
                              ? `(${clickedMarkerCompanyInfoData.companyChemResponseList[0].chemResponse.mttrnmkor})`
                              : ""
                          } ${
                            clickedMarkerCompanyInfoData.companyChemResponseList
                              .length -
                              1 !==
                            0
                              ? `외 ${
                                  clickedMarkerCompanyInfoData
                                    .companyChemResponseList.length - 1
                                }건`
                              : ""
                          }

                `}
                        </p>
                      ) : (
                        <></>
                      )}
                    </>
                  ) : (
                    <></>
                  )}
                </div>
              </>
            ) : (
              <></>
            )}

            {/* 화학물질 */}
            {activeIdx === 2 && clickedMarkerChemInfoData ? (
              <>
                <div className={styles.marker_popup_top}>
                  <Chip
                    chipData={
                      clickedMarkerChemInfoData.tagType.type === "EVACUATION"
                        ? {
                            name: "주민대피물질",
                            value: "주민대피물질",
                            group: "",
                          }
                        : clickedMarkerChemInfoData.tagType.type ===
                          "ACDNT_PREP"
                        ? {
                            name: "사고대비물질",
                            value: "사고대비물질",
                            group: "",
                          }
                        : {
                            name: "취급업체(기타)",
                            value: "취급업체(기타)",
                            group: "",
                          }
                    }
                    borderColor={
                      clickedMarkerChemInfoData.tagType.type == "EVACUATION"
                        ? `var(--alert-er)`
                        : clickedMarkerChemInfoData.tagType.type == "ACDNT_PREP"
                        ? `#ff4c00`
                        : `#ff9933`
                    }
                    color={
                      clickedMarkerChemInfoData.tagType.type == "EVACUATION"
                        ? `var(--alert-er)`
                        : clickedMarkerChemInfoData.tagType.type == "ACDNT_PREP"
                        ? `#ff4c00`
                        : `#ff9933`
                    }
                    chipLeftIcon={
                      <RiBuildingFill
                        role="img"
                        aria-label="취급업체 아이콘"
                        color="var(--gray-900)"
                        size={16}
                      />
                    }
                    chipStyle="round"
                    bgColor="white"
                  />
                  {getIsLoginUser(session) ? (
                    <a
                      href={`/cwchemical/Sm/SysCompany/${clickedMarkerChemInfoData.companySeq}/modi`}
                    >
                      {clickedMarkerChemInfoData!.companyNm}
                    </a>
                  ) : (
                    <p>{clickedMarkerChemInfoData!.companyNm}</p>
                  )}
                </div>
                <div className={styles.marker_popup_bottom}>
                  <p>{`주소 : ${clickedMarkerChemInfoData!.roadNmAddr}`}</p>
                  {clickedMarkerChemInfoData!.tpbizNm ? (
                    <p>업종 : {clickedMarkerChemInfoData!.tpbizNm}</p>
                  ) : (
                    <></>
                  )}
                  <>
                    {isAdmin ? (
                      <>
                        {clickedMarkerChemInfoData!.telNo ? (
                          <p>
                            연락처 :{" "}
                            {clickedMarkerChemInfoData!.telNo
                              .replace(/[^0-9]/g, "")
                              .replace(
                                /^(\d{2,3})(\d{3,4})(\d{4})$/,
                                `$1-$2-$3`
                              )}
                          </p>
                        ) : (
                          <></>
                        )}
                        {clickedMarkerChemInfoData!.yearTrtmntSz ? (
                          <p>
                            연간취급량 :{" "}
                            {clickedMarkerChemInfoData!.yearTrtmntSz}
                            {`(톤)`}
                          </p>
                        ) : (
                          <></>
                        )}
                        {clickedMarkerChemInfoData!.companyChemResponseList &&
                        clickedMarkerChemInfoData.companyChemResponseList
                          .length ? (
                          <p>
                            {" "}
                            {`취급물질명 : ${
                              clickedMarkerChemInfoData
                                .companyChemResponseList[0].chemResponse
                                .mttrnmeng
                            }${
                              clickedMarkerChemInfoData
                                .companyChemResponseList[0].chemResponse
                                .mttrnmkor
                                ? `(${clickedMarkerChemInfoData.companyChemResponseList[0].chemResponse.mttrnmkor})`
                                : ""
                            } ${
                              clickedMarkerChemInfoData.companyChemResponseList
                                .length -
                                1 !==
                              0
                                ? `외 ${
                                    clickedMarkerChemInfoData
                                      .companyChemResponseList.length - 1
                                  }건`
                                : ""
                            }

                `}
                          </p>
                        ) : (
                          <></>
                        )}
                      </>
                    ) : (
                      <></>
                    )}
                  </>
                </div>
              </>
            ) : (
              <></>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

```