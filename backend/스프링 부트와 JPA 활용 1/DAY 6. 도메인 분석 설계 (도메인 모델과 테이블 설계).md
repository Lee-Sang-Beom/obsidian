
#### 1. 도메인 모델과 테이블 설계 다이어그램

![[UML 다이어그램 (관계).png]]

#### 2. 관계 설정 및 설명

###### ※ 회원, 주문, 상품의 관계
- 회원은 여러 상품을 주문할 수 있다. (회원과 주문은 1:N 관계)
- 주문 1개에 대하여, 배송이 1개 이루어진다. (주문과 배송은 1:1 관계)
- 회원이 한 번 주문할 때, 여러 개의 상품을 주문할 수 있다. 
	 - 그리고 상품은 여러 주문에 포함될 수 있다.
	 - 따라서, 주문과 상품은 다대다 관계(N:N)이다.
	 - 하지만, 다대다 관계는 관계형 데이터베이스는 물론이고, Entity에서도 거의 사용하지 않는다. 그래서 여기서는, 주문상품이라는 Entity를 추가하여 **다대다(N:N) 관계를 일대다(1:N) 관계와 다대일(N:1) 관계로 풀어냈다.**

###### ※ 상품 분류
- 상품은 도서, 음반, 영화로 구분된다.
- 이들은 **상품**이라는 공통 속성을 사용하므로, 상속 구조로 표현했다.


#### 3. 회원 엔티티 분석 클래스 다이어그램
![[회원 엔티티 분석.png]]

###### ※ 회원(Member)
- 이름과 임베디드 타입인 주소, 주문 리스트를 가진다.
###### ※ 주문(Order)
- 한 번 주문시 여러 상품을 주문할 수 있으므로 주문과 주문상품`(OrderItem)`은 일대다 관계다. 
- 주문은 상품을 주문한 회원과 배송 정보, 주문 날짜, 주문 상태`(status)`를 가지고 있다. 주문 상태는 열거형을 사용했는데 주문`(ORDER)`, 취소`(CANCEL)`을 표현할 수 있다
###### ※ 주문 상품(OrderItem)
- 주문한 상품 정보와 주문 금액`(orderPrice)`, 주문 수량`(count)` 정보를 가지고 있다. 
	- 보통 `OrderLine` , `LineItem` 으로 많이 표현한다.
###### ※ 상품(Item)
- 이름, 가격, 재고수량`(stockQuantity)`을 가지고 있다.
- 상품을 주문하면 재고수량이 줄어든다. 상품의 종류로는 도서, 음반, 영화가 있는데 각각은 사용하는 속성이 조금씩 다르다.
###### ※ 배송(Delivery)
- 주문 시, 하나의 배송 정보를 생성한다.
- 주문과 배송은 1:1 관계이다.
###### ※ 카테고리(Category)
- 상품과 다대다(N:N) 관계를 맺는다.
- `parent`, `child`로 부모, 자식 카테고리를 연결한다.
###### ※ 주소(Address)
- 값 타입(임베디드 타입)이다.
- 회원과 배송에서 사용된다.


#### 4. 회원 테이블 분석
![[회원 테이블 분석.png]]


#### 5. 연관관계 매핑 분석

###### ※ 회원과 주문
- 일대다(1:N), 다대일(N:1)의 양방향 관계이다.
- 연관관계의 주인을 정할 때, 외래 키가 있는 주문(일대다 관계 중, **"다(多)"** 에 해당하는 부분)을 연관 관계의 주인으로 정하는 것이 좋다
- 그러므로 `Order.member` 를 `ORDERS.MEMBER_ID` 외래 키와 매핑한다
###### ※ 주문상품과 주문
- 다대일(N:1)의 양방향 관계이다.
- 외래 키가 주문 상품에 있으므로, 주문상품이 연관관계의 주인이다.
- 그러므로 `OrderItem.order`를 `ORDER_ITEM.ORDER_ID` 외래 키와 매핑한다.
###### ※ 주문상품과 상품
- 다대일(N:1)의 단방향 관계이다.
- `OrderItem.item`을 `ORDER_ITEM_ITEM_ID` 외래키와 매핑한다.
###### ※ 주문과 배송
- 일대일(1:1) 양방향 관계이다.
- `Order.delivery`를 `ORDERS.DELIVERY_ID` 외래키와 매핑한다.
###### ※ 카테고리와 상품
- `@ManyToMany`를 사용하여, 매핑한다.
- 실무에서는 이 annotation은 사용하지 말자.

> [!note] 참고: 외래키가 있는 곳을 연관관계의 주인으로 정하자
> - 연관관계의 주인은 단순히 외래 키를 누가 관리하냐의 문제이지 비즈니스상 우위에 있다고 주인으로 정하면 안된다.
> - 예를 들어서 자동차와 바퀴가 있으면, 일대다 관계에서 항상 다(多)쪽에 외래 키가 있으므로 외래 키가 있는 바퀴를 연관관계의 주인으로 정하면 된다. 
> 	- 물론 자동차를 연관관계의 주인으로 정하는 것이 불가능한 것은 아니지만, 자동차를 연관관계의 주인으로 정하면 자동차가 관리하지 않는 바퀴 테이블의 외래 키 값이 업데이트되므로 관리와 유지보수가 어렵고, 추가적으로 별도의 업데이트 쿼리가 발생하는 성능 문제도 있다.