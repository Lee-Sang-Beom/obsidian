### ğŸ“Œ ìš”êµ¬ì‚¬í•­

- íŒŸìºìŠ¤íŠ¸ íƒ€ì…ë³„ë¡œ ë‹¤ë¥¸ API í˜¸ì¶œ
- í˜ì´ì§€ ë‹¨ìœ„ ë°ì´í„° ë¡œë”©
- ëª¨ë“  í˜ì´ì§€ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ë³‘í•©
- React key ì¤‘ë³µ ë¬¸ì œ í•´ê²°

### ì»¤ìŠ¤í…€ í›… êµ¬í˜„

```tsx
import { useLocation } from 'react-router-dom'
import { useInfiniteQuery } from '@tanstack/react-query'
import { podcastService } from '@/service/podcast-service.ts'
import { useMemo } from 'react'

interface UseInfinitePodcastsOptions {
  type?: PodcastRequestTypeEnum
  pageSize?: number
  enabled?: boolean
}

export const useInfinitePodcasts = ({
  type = 'domestic',
  pageSize = 10,
  enabled = true,
}: UseInfinitePodcastsOptions = {}) => {
  const location = useLocation()

  const {
    data: podcastData,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    isLoading,
    isError,
    error,
    refetch,
  } = useInfiniteQuery({
    queryKey: ['useInfinitePodcasts', type, pageSize, location.pathname],
    
    queryFn: async ({ pageParam = 1 }) => {
      // íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ API í˜¸ì¶œ
      if (type === 'speech-output') {
        return await podcastService.getLiveSpeechOutputPodcasts({
          type,
          nowPage: pageParam,
          pageSize,
        })
      } else {
        return await podcastService.getPodcasts({
          type,
          nowPage: pageParam,
          pageSize,
        })
      }
    },
    
    getNextPageParam: (lastPage, allPages) => {
      const currentPage = allPages.length
      const totalPages = lastPage.lastPage
      return currentPage < totalPages ? currentPage + 1 : undefined
    },
    
    initialPageParam: 1,
    enabled,
  })

  // ëª¨ë“  í˜ì´ì§€ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ë³‘í•©
  const flattenedData = useMemo(() => {
    if (!podcastData?.pages) return []
    
    return podcastData.pages.flatMap((page, pageIndex) =>
      page.items.map((item, itemIndex) => {
        const uniqueKeyField = 'lmTitle' in item 
          ? `${item.lmTitle}-${item.lmContent}` 
          : item.title
        
        return {
          ...item,
          _uniqueKey: `${pageIndex}-${itemIndex}-${uniqueKeyField}`,
        }
      }),
    )
  }, [podcastData?.pages])

  return {
    data: flattenedData,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    isLoading,
    isError,
    error,
    refetch,
  }
}
```

---

## ì£¼ìš” íŠ¹ì§• ë¶„ì„

### 1. **ë™ì  API ì„ íƒ**

```tsx
queryFn: async ({ pageParam = 1 }) => {
  if (type === 'speech-output') {
    return await podcastService.getLiveSpeechOutputPodcasts(...)
  } else {
    return await podcastService.getPodcasts(...)
  }
}
```

íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ìœ ì—°í•œ ë°ì´í„° fetchingì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### 2. **ìŠ¤ë§ˆíŠ¸í•œ QueryKey**

```tsx
queryKey: ['useInfinitePodcasts', type, pageSize, location.pathname]
```

íƒ€ì…, í˜ì´ì§€ í¬ê¸°, í˜„ì¬ ê²½ë¡œê¹Œì§€ í¬í•¨í•˜ì—¬ ì •í™•í•œ ìºì‹±ê³¼ ë¦¬í˜ì¹˜ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

### 3. **ë°ì´í„° ë³‘í•©ê³¼ ê³ ìœ  í‚¤ ìƒì„±**

```tsx
const flattenedData = useMemo(() => {
  return podcastData.pages.flatMap((page, pageIndex) =>
    page.items.map((item, itemIndex) => ({
      ...item,
      _uniqueKey: `${pageIndex}-${itemIndex}-${uniqueKeyField}`,
    }))
  )
}, [podcastData?.pages])
```

ëª¨ë“  í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê³ , React key ì¤‘ë³µ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ê³ ìœ í•œ í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

---

## ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸°

```tsx
import type { DetailPodcastResponse, PodcastRequestTypeEnum, PodcastResponse } from '../../types'  
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs.tsx'  
import { useCallback, useEffect, useRef, useState } from 'react'  
import { useInfinitePodcasts } from '@/pages/news/hooks/action/use-infinite-podcasts.ts'  
import { useGetPodcastDetail } from '@/pages/news/hooks/action/use-get-podcast-detail.ts'  
import useAppPlayerStore from '@/store/use-app-audio-store.ts'  
import PodcastList from './podcast-list'  
import { logScreenView } from '@/log/use-analytics.ts'  
  
interface NewsBottomSectionProps {  
  onOpenPodcast: (podcast: DetailPodcastResponse, audioSrc: string | null) => void  
}  
  
export default function NewsBottomSection({ onOpenPodcast }: NewsBottomSectionProps) {  
  const [scheduleFilter, setScheduleFilter] = useState<PodcastRequestTypeEnum>('domestic')  
  const [activeTab, setActiveTab] = useState<string>('domestic')  
  const observerRef = useRef<IntersectionObserver | null>(null)  
  const [selectedPodcastId, setSelectedPodcastId] = useState<string | null>(null)  
  const [pendingAudioSrc, setPendingAudioSrc] = useState<string | null>(null)  
  
  // ì•± í”Œë ˆì´ì–´ ìŠ¤í† ì–´ ì‚¬ìš©  
  const { isPlaying, currentTrack, currentPlayerType, playAudio, pauseAudio, resumeAudio, stopAudio } =  
    useAppPlayerStore()  
  
  const {  
    data: podcastsData,  
    fetchNextPage,  
    hasNextPage,  
    isFetchingNextPage,  
    isLoading: isPodcastsLoading,  
    isError,  
    error: podcastsError,  
    refetch,  
  } = useInfinitePodcasts({  
    type: scheduleFilter,  
    pageSize: 10,  
    enabled: true,  
  })  
  
  const {  
    data: podcastDetail,  
    isLoading: isDetailLoading,  
    isError: isDetailError,  
  } = useGetPodcastDetail({  
    id: selectedPodcastId || '',  
    enabled: !!selectedPodcastId,  
  })  
  
  const handleRefresh = useCallback(() => {  
    refetch()  
  }, [refetch])  
  
  const lastPodcastElementRef = useCallback(  
    (node: HTMLDivElement | null) => {  
      if (isPodcastsLoading) return  
      if (observerRef.current) observerRef.current.disconnect()  
  
      observerRef.current = new IntersectionObserver(entries => {  
        if (entries[0].isIntersecting && hasNextPage && !isFetchingNextPage) {  
          fetchNextPage()  
        }  
      })  
  
      if (node) observerRef.current.observe(node)  
    },  
    [isPodcastsLoading, hasNextPage, isFetchingNextPage, fetchNextPage],  
  )  
  
  const handleTabChange = (value: string) => {  
    setActiveTab(value)  
    setScheduleFilter(value as PodcastRequestTypeEnum)  
  }  
  
  // eslint-disable-next-line react-hooks/exhaustive-deps  
  const getAudioSrc = (podcast: PodcastResponse): string | null => {  
    if (activeTab === 'speech-output' || !podcast.audioUrl) {  
      return null  
    }  
    return podcast.audioUrl  
  }  
  
  // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì˜¤ë””ì˜¤ ì¬ìƒ/ì¼ì‹œì •ì§€ ì²˜ë¦¬  
  const handleImageClick = useCallback(  
    async (podcast: PodcastResponse) => {  
      try {  
        const audioSrc = getAudioSrc(podcast)  
        if (!audioSrc) return  
  
        const audioInfo = {  
          url: audioSrc,  
          title: podcast.lmTitle,  
          artist: `íŒŸìºìŠ¤íŠ¸ ë‰´ìŠ¤: ${podcast.newsType === 'DOMESTIC' ? 'êµ­ë‚´' : 'ê¸€ë¡œë²Œ'}`,  
          albumArt: podcast.thumbnailUrl || undefined,  
        }  
  
        const isSameTrack = currentTrack?.url === audioSrc  
  
        // ê°™ì€ íŠ¸ë™ì´ë©´ì„œ ì›¹ í”Œë ˆì´ì–´ì¸ ê²½ìš° í† ê¸€  
        if (isSameTrack && currentPlayerType === 'web') {  
          await (isPlaying ? pauseAudio() : resumeAudio())  
          return  
        }  
  
        // ë‹¤ë¥¸ íŠ¸ë™ì´ë©´ì„œ ì›¹ í”Œë ˆì´ì–´ê°€ ì¬ìƒ ì¤‘ì¸ ê²½ìš° ì •ì§€  
        if (!isSameTrack && currentTrack && currentPlayerType === 'web') {  
          await stopAudio()  
        }  
  
        // ìƒˆë¡œìš´ íŠ¸ë™ ì¬ìƒ ë˜ëŠ” ì•± í”Œë ˆì´ì–´ì—ì„œ ê°™ì€ íŠ¸ë™ ì¬ìƒ  
        await playAudio(audioInfo)  
      } catch (error) {  
        console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error)  
      }  
    },  
    [currentTrack, currentPlayerType, isPlaying, playAudio, pauseAudio, resumeAudio, stopAudio, getAudioSrc],  
  )  
  
  const handlePodcastPlay = useCallback(  
    async (podcast: PodcastResponse, audioSrc: string | null) => {  
      try {  
        // íŒŸìºìŠ¤íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•  ë•ŒëŠ” í•­ìƒ ì˜¤ë””ì˜¤ ì •ì§€  
        if (currentPlayerType === 'web') {  
          await stopAudio()  
        }  
  
        if (selectedPodcastId === podcast.id && isDetailLoading) {  
          return  
        }  
  
        setSelectedPodcastId(podcast.id)  
        setPendingAudioSrc(audioSrc)  
      } catch (error) {  
        console.error('íŒŸìºìŠ¤íŠ¸ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error)  
      }  
    },  
    [selectedPodcastId, isDetailLoading, stopAudio, currentPlayerType],  
  )  
  
  useEffect(() => {  
    if (podcastDetail && selectedPodcastId && !isDetailLoading && !isDetailError) {  
      onOpenPodcast(podcastDetail, pendingAudioSrc)  
      setSelectedPodcastId(null)  
      setPendingAudioSrc(null)  
    }  
  }, [podcastDetail, selectedPodcastId, isDetailLoading, isDetailError, onOpenPodcast, pendingAudioSrc])  
  
  useEffect(() => {  
    if (isDetailError && selectedPodcastId) {  
      setSelectedPodcastId(null)  
      setPendingAudioSrc(null)  
    }  
  }, [isDetailError, selectedPodcastId])  
  
  useEffect(() => {  
    if (activeTab === 'domestic') {  
      logScreenView('íŒŸìºìŠ¤íŠ¸: êµ­ë‚´ ë‰´ìŠ¤ íƒ­', 'íŒŸìºìŠ¤íŠ¸ íƒ­')  
    } else if (activeTab === 'overseas-bitcoin') {  
      logScreenView('íŒŸìºìŠ¤íŠ¸: ê¸€ë¡œë²Œ & ì½”ì¸ íƒ­', 'íŒŸìºìŠ¤íŠ¸ íƒ­')  
    } else if (activeTab === 'speech-output') {  
      logScreenView('íŒŸìºìŠ¤íŠ¸: ì‹¤ì‹œê°„ ë°œì–¸ íƒ­', 'íŒŸìºìŠ¤íŠ¸ íƒ­')  
    }  
  }, [activeTab])  
  
  return (  
    <div className="mb-4">  
      <Tabs defaultValue="domestic" value={activeTab} onValueChange={handleTabChange}>  
        <TabsList className="grid w-full grid-cols-3 gap-1 min-[320px]:gap-2">  
          <TabsTrigger value="domestic" className="px-1 text-xs min-[320px]:px-3">  
            <span className="hidden min-[320px]:inline">êµ­ë‚´ ë‰´ìŠ¤</span>  
            <span className="min-[320px]:hidden">êµ­ë‚´</span>  
          </TabsTrigger>          <TabsTrigger value="overseas-bitcoin" className="px-1 text-xs min-[320px]:px-3">  
            <span className="hidden min-[360px]:inline">ê¸€ë¡œë²Œ & ì½”ì¸ ë‰´ìŠ¤</span>  
            <span className="hidden min-[320px]:inline min-[360px]:hidden">ê¸€ë¡œë²Œ&ì½”ì¸</span>  
            <span className="min-[320px]:hidden">ê¸€ë¡œë²Œ</span>  
          </TabsTrigger>          <TabsTrigger value="speech-output" className="px-1 text-xs min-[320px]:px-3">  
            <span className="hidden min-[320px]:inline">ì‹¤ì‹œê°„ ë°œì–¸</span>  
            <span className="min-[320px]:hidden">ì‹¤ì‹œê°„</span>  
          </TabsTrigger>        </TabsList>  
        <TabsContent value="domestic" className="mt-4">  
          <PodcastList            podcastsData={podcastsData}  
            activeTab={activeTab}  
            hasNextPage={hasNextPage}  
            isFetchingNextPage={isFetchingNextPage}  
            isPodcastsLoading={isPodcastsLoading}  
            isError={isError}  
            podcastsError={podcastsError}  
            lastPodcastElementRef={lastPodcastElementRef}  
            onRefresh={handleRefresh}  
            onPodcastPlay={handlePodcastPlay}  
            onImageClick={handleImageClick}  
          />  
        </TabsContent>  
        <TabsContent value="overseas-bitcoin" className="mt-4">  
          <PodcastList            podcastsData={podcastsData}  
            activeTab={activeTab}  
            hasNextPage={hasNextPage}  
            isFetchingNextPage={isFetchingNextPage}  
            isPodcastsLoading={isPodcastsLoading}  
            isError={isError}  
            podcastsError={podcastsError}  
            lastPodcastElementRef={lastPodcastElementRef}  
            onRefresh={handleRefresh}  
            onPodcastPlay={handlePodcastPlay}  
            onImageClick={handleImageClick}  
          />  
        </TabsContent>  
        <TabsContent value="speech-output" className="mt-4">  
          <PodcastList            podcastsData={podcastsData}  
            activeTab={activeTab}  
            hasNextPage={hasNextPage}  
            isFetchingNextPage={isFetchingNextPage}  
            isPodcastsLoading={isPodcastsLoading}  
            isError={isError}  
            podcastsError={podcastsError}  
            lastPodcastElementRef={lastPodcastElementRef}  
            onRefresh={handleRefresh}  
            onPodcastPlay={handlePodcastPlay}  
            onImageClick={handleImageClick}  
          />  
        </TabsContent>      </Tabs>    </div>  )  
}
```

---

## í•µì‹¬ í¬ì¸íŠ¸

- **íƒ€ì…ë³„ ë¶„ê¸° ì²˜ë¦¬**: í•˜ë‚˜ì˜ í›…ìœ¼ë¡œ ì—¬ëŸ¬ API ì—”ë“œí¬ì¸íŠ¸ ëŒ€ì‘
- **ë°ì´í„° ë³‘í•©**: í˜ì´ì§€ë³„ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í†µí•©
- **ê³ ìœ  í‚¤ ê´€ë¦¬**: React ë Œë”ë§ ìµœì í™”ë¥¼ ìœ„í•œ í‚¤ ìƒì„±
- **ìºì‹± ìµœì í™”**: ê²½ë¡œì™€ íŒŒë¼ë¯¸í„°ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ queryKey ì„¤ê³„