
#### 1. SOP, CORS

- **SOP**(Same Origin Policy): 다른 출처의 리소스를 사용하는 것을 제한하는 보안 정책
- **CORS**(Cross-Origin Resource Sharing): 추가적인 HTTP Header를 사용하여, 한 출처에서 실행중인 웹 애플리케이션이 다른 출처에 있는 외부 리소스에 **접근할 수 있는 권한을 부여할 수 있도록 브라우저에게 알려주는 정책**

- 브라우저는 기본적으로 **동일 출처 정책(SOP)** 을 지켜, 다른 **Origin**의 리소스 접근을 금지한다.
	- 개발환경이나 Postman을 사용하여 API를 테스트할 때는 문제가 없다가, 브라우저 상에서 API를 호출할 때 문제가 발생하는 이유가 브라우저가 SOP를 준수하기 때문인 것이다.

#### 2. Origin(출처)

> [이미지 출처: 쿼카러버의 기술 블로그](https://etloveguitar.tistory.com/83)
![[Pasted image 20240416103137.png]]

- Origin(출처)는 위 이미지와 같은 URL 구조에서 **Protocol, Host, Port**를 합친 것을 의미한다.

- Cross-Origin은 다음 중 하나라도 다른 경우에 발생한다.
	- 프로토콜 (`http !== https`)
	- 도메인 (`domain.com !== other-domain.com`)
	- 포트번호 (`:3000port !== :8000port`)
### CORS 에러 해결 방법


- CORS 에러를 해결하고, 외부 리소스를 위해서는 서버의 응답에 특정 헤더를 포함하는 방식으로 해결할 수 있습니다.
- 서버 측에서 **Access-Control-Allow-Origin** 헤더에 명시적으로 특정 출처값를 입력해주면, 입력한 해당 출처의 페이지에서는, 외부 리소스 접근이 가능하게 됩니다

##### **그 외)**


1. Access-Control-Allow-Method: 특정 HTTP Method만 리소스에 접근이 가능하도록 허용합니다.
2. Access-Control-Expose-Headers: 자바스크립트에서 헤더에 접근할 수 있도록 허용합니다.

---

### CORS 동작 원리


- 먼저, 웹 애플리케이션이 다른 출처의 리소스에 접근 시, HTTP 프로토콜을 사용해 요청을 보내며, 요청 헤더 내의 origin 필드에 요청을 보내는 출처를 담아 보냅니다.
    
- 이후, 서버는 **Access-control-allow-origin** 헤더에 **"리소스 접근을 허용할 출처"**를 포함하여 응답합니다.
    
- 그리고 브라우저는 자신이 보냈던 Origin 헤더값이 **응답 헤더 Access-control-allow-origin 의 목록**에 포함되어있는지를 검사합니다.
    

---

### simple request (CORS요청의 유형 1)


- 해당 유형은 예비요청 없이 서버에 본 요청을 보내는 방법입니다.
    
- 서버가 **Access-control-allow-origin** 헤더를 포함해 응답하면, 브라우저는 요청 시, Origin값과의 비교를 통해 CORS 정책 위반을 하였는지를 검사합니다.
    
- 이 때의 요청은, 메소드가 GET, HEAD, POST 중 하나여야 하고, 헤더 사용에 제한이 있다는 특징이 있습니다.
    
    - **이 조건을 만족해야 해당 요청이 안전한 요청으로 취급되기 때문**입니다.

---

### Preflight Request (CORS요청의 유형 2)


- 해당 유형은 브라우저가 요청을 한번에 보내지 않고, **예비 요청과 본 요청을 나눠 전송**하는 방법입니다.
    
- 이 예비 요청은 **Preflight**이라 부르고, 실제 요청에 사용할 메소드와 헤더 등을 포함하여 요청을 보냅니다. 이 때 **OPTION** 메소드가 사용됩니다.
    
- 먼저, 브라우저는 서버에 예비 요청을 먼저 보내, 실제 요청이 전송하기에 안전한지를 먼저, 확인합니다.
    
- 그리고, 서버는 응답으로 **현재 허용되는 Origin, 메소드, 헤더 등의 정보를 응답 헤더에 담아 반환**합니다.
    
- 응답을 받으면, 브라우저는 **응답 정보와 자신이 전송한 실제 요청에 사용할 정보(메소드와 헤더)를 비교**해 실제 요청의 안정성을 검사합니다.
    
- 안정성 검사가 완료되면, 브라우저측은 본 요청을 보냅니다.
    
- 본 요청에 대한 응답을 받으면 브라우저는 최종적으로 응답 데이터를 자바스크립트에 넘겨줍니다.
    

---

### 인증 정보를 포함한 요청 (CORS요청의 유형 3)


- 인증 정보를 포함한 요청의 경우, **클라이언트 측**에서는 **withCredentials(크리덴셜)**과 같은 별도의 설정을 해 주어야 합니다. 별도 설정을 해주지 않으면, **인증정보는 자동으로 서버에 전송**되지 않습니다.
    
- 응답 시에는 **Access-control-allow-origin 헤더에는 와일드카드가 아닌 분명한 출처를 설정**해주어야 하고, **Access-Control-Allow-Credentials를 true**로 설정해주어야 합니다. 그렇지 않으면 **브라우저에 의해 응답이 거부**됩니다.