
#### 5.  Updating an invoice (Next.js with Server Actions)

##### 5-0.  Invoice(송장) 업데이트(수정) 단계
-  Invoice(송장)을 업데이트하는 단계는 아래와 같다.
	1. 동적 경로 세그먼트 생성: Invoice(송장) ID를 사용하여 새로운 동적 경로 세그먼트를 만듭니다.
	2. Invoice(송장) ID 읽기: 페이지의 매개변수(params)에서 인보이스 ID를 읽어옵니다.
	3. 특정 Invoice(송장) 가져오기: 데이터베이스에서 해당 Invoice(송장)을 가져옵니다.
	4. 양식에 Invoice(송장) 데이터 미리 채우기: 가져온 Invoice(송장) 데이터를 양식에 미리 채워 넣습니다.
	5. 데이터베이스에서 Invoice(송장) 데이터 업데이트: 양식에서 수정된 데이터를 데이터베이스에 업데이트합니다.

###### 5-1. 동적 경로 세그먼트 생성
- Next.js에서는 경로 세그먼트(경로의 일부 이름)를 미리 알 수 없을 때, 데이터에 기반한 동적 경로를 만들 수 있다.
	- 블로그 글의 제목이나 제품 페이지의 ID 같은 데이터에 기반한 경로를 설정할 때 유용하다.

- 동적 경로 세그먼트는 폴더 이름을 대괄호(`[]`)로 감싸서 만들 수 있다.
	- 예: `[id]`, `[post]`, `[slug]`

- 이제, `/invoices` 폴더 내에서 `[id]`라는 동적 경로를 생성하고, 그 안에 `edit`라는 폴더를 만들어 `page.tsx` 파일을 추가해보자.
	- 일단 필자는 아래와 같이 페이지를 초기화했다.
> `/app/dashboard/invoices/[id]/edit/page.tsx`
```tsx
export default function Page() {
  return <>Update Page</>;
}
```

- `<Table>` 컴포넌트에서 `UpdateInvoice` 버튼을 사용할 때, 해당 버튼은 테이블에서 각 인보이스의 `id`를 전달받도록 되어있다. 이 `id`는 나중에 경로로 사용된다.
> `/app/ui/invoices/table.tsx`
```tsx
export default async function InvoicesTable({
  query,
  currentPage,
}: {
  query: string;
  currentPage: number;
}) {
  return (
    // ...
    <td className="flex justify-end gap-2 whitespace-nowrap px-6 py-4 text-sm">
      {/* 이부분 */}
      <UpdateInvoice id={invoice.id} /> 
      <DeleteInvoice id={invoice.id} />
    </td>
    // ...
  );
}
```

- 이제, `<UpdateInvoice />` 컴포넌트에서, `Link`의 `href` 속성에 `id` 값을 받아서 동적 경로를 생성해야 한다.
	- 템플릿 리터럴을 사용하여 경로에 `id`를 삽입하고, 이를 통해 동적 경로로 이동할 수 있다.
>`/app/ui/invoices/button.tsx`
```tsx
export function UpdateInvoice({ id }: { id: string }) {
  return (
    <Link
      // href="/dashboard/invoices"
      href={`/dashboard/invoices/${id}/edit`}
      className="rounded-md border p-2 hover:bg-gray-100"
    >
      <PencilIcon className="w-5" />
    </Link>
  );
}
```
- 이 코드에서는 `id` 값을 기반으로 동적으로 `/dashboard/invoices/[id]/edit` 경로로 이동할 수 있게 설정하고 있다.
	- `<Link/>` 컴포넌트에 템플릿 리터럴(`/dashboard/invoices/${id}/edit`)을 사용하여 `id` 값을 경로에 포함시킨다.

###### 5-2. Invoice(송장) ID 읽기
- 템플릿 리터럴으로 연결한 동적 경로 `[id]`를 통해, Invoice(송장)의 `id`를 URL에서 추출할 수 있다.
	- 이 `id` 값을 페이지 컴포넌트에서 사용하여 해당 Invoice 데이터를 가져오고, Form 데이터를 미리 채우도록 할 수 있다.

- `/app/dashboard/invoices/[id]/edit/page.tsx` 파일에는 기본적인 폼과 경로 표시를 위한 컴포넌트들흘 설정할 예정이다. `Form` 컴포넌트는 인보이스를 수정하기 위한 폼을 제공하고, `Breadcrumbs`는 페이지의 경로를 나타낸다.
	- `Breadcrumbs` 컴포넌트는 네비게이션을 돕기 위해 현재 페이지의 위치를 나타낸다. 이때, `href` 속성에서 `id`가 동적으로 추가된다.
	- `Form` 컴포넌트는 Invoice 데이터를 받아와서, 고객명, Invoice 금액, 상태 등을 미리 채운 상태로 되도록 한다. 이 Form은 `edit-form.tsx`에서 가져온다.
```tsx
import Form from "@/app/ui/invoices/edit-form";
import Breadcrumbs from "@/app/ui/invoices/breadcrumbs";
import { fetchCustomers } from "@/app/lib/data";

export default async function Page() {
  return (
    <main>
      <Breadcrumbs
        breadcrumbs={[
          { label: "Invoices", href: "/dashboard/invoices" },
          {
            label: "Edit Invoice",
            href: `/dashboard/invoices/${id}/edit`,
            active: true,
          },
        ]}
      />
      <Form invoice={invoice} customers={customers} />
    </main>
  );
}
```

- 페이지 컴포넌트가 특정 Invoice 데이터를 가져오기 위해서는, 이전에 템플릿 리터럴로 걸어놓은 URL에 있는 `id` 값을 읽어와야 한다. `id` 값은 Next.js에서 제공하는 `params`를 통해 얻을 수 있다.
	- 페이지 컴포넌트가 `params`를 받아서 `id` 값을 추출하도록 코드를 업데이트하면 아래와 같은 결과가 나온다.
```tsx
import Form from "@/app/ui/invoices/edit-form";
import Breadcrumbs from "@/app/ui/invoices/breadcrumbs";
import { fetchCustomers } from "@/app/lib/data";

export default async function Page({ params }: { params: { id: string } }) {
  const id = params.id;

  return (
    <main>
      <Breadcrumbs
        breadcrumbs={[
          { label: "Invoices", href: "/dashboard/invoices" },
          {
            label: "Edit Invoice",
            href: `/dashboard/invoices/${id}/edit`,
            active: true,
          },
        ]}
      />
      <Form invoice={invoice} customers={customers} />
    </main>
  );
}
```

###### 5-3. 특정 Invoice(송장) 가져오기
- 여기서는 특정 Invoice 정보를 가져오기 위해서 `fetchInvoiceById` 함수를 사용하고, 이 함수에 `id` 값을 인수로 전달할 것이다. 또한, 고객 데이터를 드롭다운에서 사용할 수 있도록 `fetchCustomers` 함수를 불러올 것이다.

- 두 데이터를 병렬로 가져오려면 `Promise.all`을 사용하면 된다. 이를 통해 Invoice 데이터와 고객 데이터를 동시에 불러올 수 있다.
	- `Promise.all`은 병렬로 여러 비동기 작업을 처리할 수 있어, 두 데이터를 동시에 받아오는 데 효과적이다.